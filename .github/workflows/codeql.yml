name: "ðŸ” CodeQL Security Analysis"

on:
  push:
    branches: [ "main", "develop" ]
  pull_request:
    branches: [ "main" ]
  schedule:
    # Executar Ã s 23:32 UTC todo sÃ¡bado
    - cron: '32 23 * * 6'
  workflow_dispatch: # Permite execuÃ§Ã£o manual

jobs:
  analyze:
    name: Analyze (${{ matrix.language }})
    runs-on: ubuntu-latest
    timeout-minutes: 360 # 6 horas
    
    permissions:
      # NecessÃ¡rio para escrever eventos de seguranÃ§a
      security-events: write
      # NecessÃ¡rio para buscar pacotes CodeQL privados
      packages: read
      # NecessÃ¡rio para workflows em repositÃ³rios privados
      actions: read
      contents: read

    strategy:
      fail-fast: false
      matrix:
        include:
        # GitHub Actions workflows
        - language: actions
          build-mode: none
          
        # C# / Blazor Server
        - language: csharp
          build-mode: autobuild
          
        # JavaScript (incluindo wwwroot/js/*.js)
        - language: javascript-typescript
          build-mode: none

    steps:
    - name: ðŸ“¥ Checkout repository
      uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
      with:
        fetch-depth: 0 # HistÃ³rico completo para anÃ¡lise

    # Setup .NET para anÃ¡lise de C#
    - name: âš™ï¸ Setup .NET
      if: matrix.language == 'csharp'
      uses: actions/setup-dotnet@25328d894dc34d01d191df4849cb7f5402e3f142 # v4.0.1
      with:
        dotnet-version: '9.0.x'

    # Restaurar dependÃªncias antes da anÃ¡lise
    - name: ðŸ“¦ Restore dependencies
      if: matrix.language == 'csharp'
      run: dotnet restore

    # Inicializar CodeQL
    - name: ðŸ” Initialize CodeQL
      uses: github/codeql-action/init@ea9e4e37992a54ee68a9622e985e60c8e8f12d9f # v3.27.5
      with:
        languages: ${{ matrix.language }}
        build-mode: ${{ matrix.build-mode }}
        # Queries recomendadas de seguranÃ§a
        queries: security-extended,security-and-quality
        # ConfiguraÃ§Ãµes adicionais
        config: |
          paths-ignore:
            - '**/obj/**'
            - '**/bin/**'
            - '**/*.Designer.cs'
            - '**/node_modules/**'
            - '**/wwwroot/lib/**'

    # Build manual se necessÃ¡rio (para C#)
    - name: ðŸ”¨ Build project
      if: matrix.language == 'csharp' && matrix.build-mode == 'manual'
      run: |
        dotnet build --configuration Release --no-restore

    # Autobuild para linguagens que precisam
    - name: ðŸ¤– Autobuild
      if: matrix.build-mode == 'autobuild'
      uses: github/codeql-action/autobuild@ea9e4e37992a54ee68a9622e985e60c8e8f12d9f # v3.27.5

    # Executar anÃ¡lise do CodeQL
    - name: ðŸ” Perform CodeQL Analysis
      uses: github/codeql-action/analyze@ea9e4e37992a54ee68a9622e985e60c8e8f12d9f # v3.27.5
      with:
        category: "/language:${{ matrix.language }}"
        upload: true
        # Fail se encontrar vulnerabilidades crÃ­ticas
        # fail-on: critical

    # Gerar resumo da anÃ¡lise
    - name: ðŸ“Š Analysis Summary
      if: always()
      run: |
        echo "## CodeQL Analysis Summary ðŸ”" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "- **Language:** ${{ matrix.language }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Build Mode:** ${{ matrix.build-mode }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Status:** ${{ job.status }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "View results in the [Security tab](https://github.com/${{ github.repository }}/security/code-scanning)" >> $GITHUB_STEP_SUMMARY
