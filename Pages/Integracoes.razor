@page "/integracoes"
@inject ConfigurationService ConfigService
@inject PayPalService PayPalService
@inject MongoDBService MongoDBService
@inject AirbnbService AirbnbService
@inject SentryService SentryService
@inject AuthService AuthService
@inject NavigationManager NavigationManager

<PageTitle>Integra√ß√µes - Hotelaria</PageTitle>

@if (!isAuthenticated)
{
    <div class="integration-lock">
        <div class="lock-card">
            <div class="lock-icon">üîí</div>
            <h2>√Årea Restrita</h2>
            <p>Acesso exclusivo para administradores</p>

            @if (!string.IsNullOrEmpty(errorMessage))
            {
                <div class="alert alert-error">
                    <span>‚ö†Ô∏è @errorMessage</span>
                </div>
            }

            <div class="login-form">
                <div class="form-group">
                    <input type="text" @bind="username" placeholder="Usu√°rio" class="input-minimal" />
                </div>
                <div class="form-group">
                    <input type="password" @bind="password" placeholder="Senha" class="input-minimal" @onkeydown="HandleKeyPress" />
                </div>
                <button class="btn-primary-minimal" @onclick="ValidateAccess">
                    Acessar
                </button>
            </div>
        </div>
    </div>
}
else
{
    <div class="integrations-page">
        <div class="page-header">
            <h1>üîå Integra√ß√µes</h1>
            <button class="btn btn-secondary" @onclick="Logout">
                üö™ Sair
            </button>
        </div>

        <!-- PayPal Integration -->
        <div class="integration-card @(editandoPayPal ? "editing" : "")">
            <div class="integration-header">
                <div class="integration-logo paypal">
                    <svg width="100" height="32" viewBox="0 0 100 32">
                        <path fill="#003087" d="M12.237 8.047l-0.89 5.67h-2.52l0.89-5.67h2.52zm8.76 0c1.97 0 3.24 0.42 3.85 1.24 0.6 0.82 0.7 2.06 0.22 3.74-0.25 0.88-0.6 1.62-1.04 2.22-0.44 0.6-0.97 1.08-1.58 1.42-0.62 0.35-1.33 0.6-2.13 0.76-0.8 0.16-1.7 0.24-2.69 0.24h-1.36l-0.55 3.54h-2.5l2.08-13.16h5.7z"/>
                    </svg>
                </div>
                <div class="integration-status">
                    <span class="status-dot @(((bool)paypalStatus["Connected"]) ? "active" : "inactive")"></span>
                    <span>@(((bool)paypalStatus["Connected"]) ? "Conectado" : "Desconectado")</span>
                </div>
            </div>
            <div class="integration-body">
                @if (!editandoPayPal)
                {
                    <div class="info-grid">
                        <div class="info-item">
                            <span class="label">Client ID:</span>
                            <code>@paypalStatus["ClientId"]</code>
                        </div>
                        <div class="info-item">
                            <span class="label">Ambiente:</span>
                            <span>@paypalStatus["Environment"]</span>
                        </div>
                    </div>
                    <div class="action-buttons">
                        <button class="btn btn-sm btn-secondary" @onclick="() => EditarPayPal()">
                            ‚úèÔ∏è Editar Credenciais
                        </button>
                        <button class="btn btn-sm btn-primary" @onclick="TestPayPal" disabled="@testing">
                            @(testing ? "Testando..." : "Testar Conex√£o")
                        </button>
                    </div>
                }
                else
                {
                    <div class="edit-form">
                        <div class="form-group">
                            <label>Client ID:</label>
                            <input type="text" @bind="paypalEditClientId" class="form-control" placeholder="Ac4buNlLjPT130g4vbvAr" />
                        </div>
                        <div class="form-group">
                            <label>API Token:</label>
                            <input type="password" @bind="paypalEditToken" class="form-control" placeholder="EEobBz_RPqm2lkPGCaGJ..." />
                        </div>
                        <div class="form-group">
                            <label>Ambiente:</label>
                            <select @bind="paypalEditEnvironment" class="form-control">
                                <option value="Sandbox">Sandbox (Teste)</option>
                                <option value="Production">Production (Produ√ß√£o)</option>
                            </select>
                        </div>
                        <div class="action-buttons">
                            <button class="btn btn-sm btn-secondary" @onclick="CancelarEdicaoPayPal">
                                Cancelar
                            </button>
                            <button class="btn btn-sm btn-success" @onclick="SalvarPayPal">
                                üíæ Salvar
                            </button>
                        </div>
                    </div>
                }
            </div>
        </div>

        <!-- MongoDB Integration -->
        <div class="integration-card @(editandoMongo ? "editing" : "")">
            <div class="integration-header">
                <div class="integration-logo mongodb">
                    <svg width="100" height="32" viewBox="0 0 100 32">
                        <path fill="#00ED64" d="M50 0c-1.7 0-3 1.3-3 3v26c0 1.7 1.3 3 3 3s3-1.3 3-3V3c0-1.7-1.3-3-3-3z"/>
                    </svg>
                </div>
                <div class="integration-status">
                    <span class="status-dot @(((bool)mongoStatus["Connected"]) ? "active" : "inactive")"></span>
                    <span>@(((bool)mongoStatus["Connected"]) ? "Conectado" : "Desconectado")</span>
                </div>
            </div>
            <div class="integration-body">
                @if (!editandoMongo)
                {
                    <div class="info-grid">
                        <div class="info-item">
                            <span class="label">Database:</span>
                            <span>@mongoStatus["Database"]</span>
                        </div>
                        <div class="info-item">
                            <span class="label">Provider:</span>
                            <span>@mongoStatus["Provider"]</span>
                        </div>
                    </div>
                    <div class="action-buttons">
                        <button class="btn btn-sm btn-secondary" @onclick="() => EditarMongo()">
                            ‚úèÔ∏è Editar Credenciais
                        </button>
                        <button class="btn btn-sm btn-primary" @onclick="TestMongoDB" disabled="@testing">
                            @(testing ? "Testando..." : "Testar Conex√£o")
                        </button>
                    </div>
                }
                else
                {
                    <div class="edit-form">
                        <div class="form-group">
                            <label>Connection String:</label>
                            <input type="password" @bind="mongoEditConnectionString" class="form-control" placeholder="mongodb+srv://..." />
                            <small>MongoDB Atlas URI completa</small>
                        </div>
                        <div class="form-group">
                            <label>Database Name:</label>
                            <input type="text" @bind="mongoEditDatabase" class="form-control" placeholder="hotelaria" />
                        </div>
                        <div class="action-buttons">
                            <button class="btn btn-sm btn-secondary" @onclick="CancelarEdicaoMongo">
                                Cancelar
                            </button>
                            <button class="btn btn-sm btn-success" @onclick="SalvarMongo">
                                üíæ Salvar
                            </button>
                        </div>
                    </div>
                }
            </div>
        </div>

        <!-- Airbnb Integration -->
        <div class="integration-card @(editandoAirbnb ? "editing" : "")">
            <div class="integration-header">
                <div class="integration-logo airbnb">
                    <svg width="100" height="32" viewBox="0 0 100 32">
                        <path fill="#FF5A5F" d="M50 16c0 8.8-7.2 16-16 16s-16-7.2-16-16 7.2-16 16-16 16 7.2 16 16z"/>
                    </svg>
                </div>
                <div class="integration-status">
                    <span class="status-dot @(((bool)airbnbStatus["Connected"]) ? "active" : "inactive")"></span>
                    <span>@(((bool)airbnbStatus["Connected"]) ? "Conectado" : "Desconectado")</span>
                </div>
            </div>
            <div class="integration-body">
                @if (!editandoAirbnb)
                {
                    <div class="info-grid">
                        <div class="info-item">
                            <span class="label">Client Key:</span>
                            <code>@airbnbStatus["ClientKey"]</code>
                        </div>
                        <div class="info-item">
                            <span class="label">Features:</span>
                            <span>Sync, Disponibilidade</span>
                        </div>
                    </div>
                    <div class="action-buttons">
                        <button class="btn btn-sm btn-secondary" @onclick="() => EditarAirbnb()">
                            ‚úèÔ∏è Editar Credenciais
                        </button>
                        <button class="btn btn-sm btn-primary" @onclick="TestAirbnb" disabled="@testing">
                            @(testing ? "Testando..." : "Testar Conex√£o")
                        </button>
                    </div>
                }
                else
                {
                    <div class="edit-form">
                        <div class="form-group">
                            <label>Client Key:</label>
                            <input type="text" @bind="airbnbEditClientKey" class="form-control" placeholder="af5e33493f7b6e3e..." />
                        </div>
                        <div class="form-group">
                            <label>Secret Key:</label>
                            <input type="password" @bind="airbnbEditSecretKey" class="form-control" placeholder="cbf0e70fc6ee6371..." />
                        </div>
                        <div class="action-buttons">
                            <button class="btn btn-sm btn-secondary" @onclick="CancelarEdicaoAirbnb">
                                Cancelar
                            </button>
                            <button class="btn btn-sm btn-success" @onclick="SalvarAirbnb">
                                üíæ Salvar
                            </button>
                        </div>
                    </div>
                }
            </div>
        </div>

        <!-- Sentry Integration -->
        <div class="integration-card @(editandoSentry ? "editing" : "")">
            <div class="integration-header">
                <div class="integration-logo sentry">
                    <svg width="100" height="32" viewBox="0 0 100 32">
                        <path fill="#362D59" d="M50 16L34 0v16h16zm0 0l16 16V16H50z"/>
                    </svg>
                </div>
                <div class="integration-status">
                    <span class="status-dot @(((bool)sentryStatus["Connected"]) ? "active" : "inactive")"></span>
                    <span>@(((bool)sentryStatus["Connected"]) ? "Conectado" : "Desconectado")</span>
                </div>
            </div>
            <div class="integration-body">
                @if (!editandoSentry)
                {
                    <div class="info-grid">
                        <div class="info-item">
                            <span class="label">Token:</span>
                            <code>@sentryStatus["Token"]</code>
                        </div>
                        <div class="info-item">
                            <span class="label">Errors:</span>
                            <span>@sentryStatus["ErrorCount"]</span>
                        </div>
                    </div>
                    <div class="action-buttons">
                        <button class="btn btn-sm btn-secondary" @onclick="() => EditarSentry()">
                            ‚úèÔ∏è Editar Credenciais
                        </button>
                        <button class="btn btn-sm btn-primary" @onclick="TestSentry" disabled="@testing">
                            @(testing ? "Testando..." : "Testar Conex√£o")
                        </button>
                    </div>
                }
                else
                {
                    <div class="edit-form">
                        <div class="form-group">
                            <label>API Token:</label>
                            <input type="password" @bind="sentryEditToken" class="form-control" placeholder="sntrys_eyJpYXQi..." />
                            <small>Token de autentica√ß√£o do Sentry</small>
                        </div>
                        <div class="action-buttons">
                            <button class="btn btn-sm btn-secondary" @onclick="CancelarEdicaoSentry">
                                Cancelar
                            </button>
                            <button class="btn btn-sm btn-success" @onclick="SalvarSentry">
                                üíæ Salvar
                            </button>
                        </div>
                    </div>
                }
            </div>
        </div>
    </div>
}

@code {
    private bool isAuthenticated = false;
    private string username = string.Empty;
    private string password = string.Empty;
    private string errorMessage = string.Empty;
    private bool testing = false;

    // Status das integra√ß√µes
    private Dictionary<string, object> paypalStatus = new();
    private Dictionary<string, object> mongoStatus = new();
    private Dictionary<string, object> airbnbStatus = new();
    private Dictionary<string, object> sentryStatus = new();

    // Estados de edi√ß√£o
    private bool editandoPayPal = false;
    private bool editandoMongo = false;
    private bool editandoAirbnb = false;
    private bool editandoSentry = false;

    // PayPal - Campos de edi√ß√£o
    private string paypalEditClientId = string.Empty;
    private string paypalEditToken = string.Empty;
    private string paypalEditEnvironment = "Sandbox";

    // MongoDB - Campos de edi√ß√£o
    private string mongoEditConnectionString = string.Empty;
    private string mongoEditDatabase = "hotelaria";

    // Airbnb - Campos de edi√ß√£o
    private string airbnbEditClientKey = string.Empty;
    private string airbnbEditSecretKey = string.Empty;

    // Sentry - Campos de edi√ß√£o
    private string sentryEditToken = string.Empty;

    protected override void OnInitialized()
    {
        if (!AuthService.EstaAutenticado())
        {
            NavigationManager.NavigateTo("/login");
            return;
        }

        if (!AuthService.TemPermissao(PerfilUsuario.Administrador))
        {
            NavigationManager.NavigateTo("/");
            return;
        }

        LoadIntegrationStatus();
    }

    private void ValidateAccess()
    {
        if (ConfigService.ValidateAccess(username, password))
        {
            isAuthenticated = true;
            errorMessage = string.Empty;
            LoadIntegrationStatus();
        }
        else
        {
            errorMessage = "Credenciais inv√°lidas";
        }
    }

    private void HandleKeyPress(KeyboardEventArgs e)
    {
        if (e.Key == "Enter")
        {
            ValidateAccess();
        }
    }

    private void Logout()
    {
        isAuthenticated = false;
        username = string.Empty;
        password = string.Empty;
    }

    private void LoadIntegrationStatus()
    {
        paypalStatus = PayPalService.GetStatus();
        mongoStatus = MongoDBService.GetStatus();
        airbnbStatus = AirbnbService.GetStatus();
        sentryStatus = SentryService.GetStatus();
    }

    // ========== PayPal ==========
    private void EditarPayPal()
    {
        paypalEditClientId = ConfigService.GetSecureValue("PAYPAL_ID") ?? "";
        paypalEditToken = ConfigService.GetSecureValue("PAYPAL_TOKEN_API") ?? "";
        paypalEditEnvironment = "Sandbox";
        editandoPayPal = true;
    }

    private void CancelarEdicaoPayPal()
    {
        editandoPayPal = false;
        paypalEditClientId = string.Empty;
        paypalEditToken = string.Empty;
    }

    private void SalvarPayPal()
    {
        if (!string.IsNullOrWhiteSpace(paypalEditClientId) && !string.IsNullOrWhiteSpace(paypalEditToken))
        {
            ConfigService.UpdateConfiguration("PAYPAL_ID", paypalEditClientId);
            ConfigService.UpdateConfiguration("PAYPAL_TOKEN_API", paypalEditToken);
            ConfigService.UpdateConfiguration("PAYPAL_ENVIRONMENT", paypalEditEnvironment);
            
            editandoPayPal = false;
            LoadIntegrationStatus();
        }
    }

    private async Task TestPayPal()
    {
        testing = true;
        await PayPalService.TestConnection();
        LoadIntegrationStatus();
        testing = false;
    }

    // ========== MongoDB ==========
    private void EditarMongo()
    {
        mongoEditConnectionString = ConfigService.GetSecureValue("MONGO_ATLAS_URI") ?? "";
        mongoEditDatabase = "hotelaria";
        editandoMongo = true;
    }

    private void CancelarEdicaoMongo()
    {
        editandoMongo = false;
        mongoEditConnectionString = string.Empty;
    }

    private void SalvarMongo()
    {
        if (!string.IsNullOrWhiteSpace(mongoEditConnectionString))
        {
            ConfigService.UpdateConfiguration("MONGO_ATLAS_URI", mongoEditConnectionString);
            ConfigService.UpdateConfiguration("MONGO_DATABASE", mongoEditDatabase);
            
            editandoMongo = false;
            LoadIntegrationStatus();
        }
    }

    private async Task TestMongoDB()
    {
        testing = true;
        await MongoDBService.TestConnection();
        LoadIntegrationStatus();
        testing = false;
    }

    // ========== Airbnb ==========
    private void EditarAirbnb()
    {
        airbnbEditClientKey = ConfigService.GetSecureValue("AIRBNB_CLIENT_KEY") ?? "";
        airbnbEditSecretKey = ConfigService.GetSecureValue("AIRBNB_SECRET_KEY") ?? "";
        editandoAirbnb = true;
    }

    private void CancelarEdicaoAirbnb()
    {
        editandoAirbnb = false;
        airbnbEditClientKey = string.Empty;
        airbnbEditSecretKey = string.Empty;
    }

    private void SalvarAirbnb()
    {
        if (!string.IsNullOrWhiteSpace(airbnbEditClientKey) && !string.IsNullOrWhiteSpace(airbnbEditSecretKey))
        {
            ConfigService.UpdateConfiguration("AIRBNB_CLIENT_KEY", airbnbEditClientKey);
            ConfigService.UpdateConfiguration("AIRBNB_SECRET_KEY", airbnbEditSecretKey);
            
            editandoAirbnb = false;
            LoadIntegrationStatus();
        }
    }

    private async Task TestAirbnb()
    {
        testing = true;
        await AirbnbService.TestConnection();
        LoadIntegrationStatus();
        testing = false;
    }

    // ========== Sentry ==========
    private void EditarSentry()
    {
        sentryEditToken = ConfigService.GetSecureValue("SENTRY_TOKEN_API") ?? "";
        editandoSentry = true;
    }

    private void CancelarEdicaoSentry()
    {
        editandoSentry = false;
        sentryEditToken = string.Empty;
    }

    private void SalvarSentry()
    {
        if (!string.IsNullOrWhiteSpace(sentryEditToken))
        {
            ConfigService.UpdateConfiguration("SENTRY_TOKEN_API", sentryEditToken);
            
            editandoSentry = false;
            LoadIntegrationStatus();
        }
    }

    private async Task TestSentry()
    {
        testing = true;
        await SentryService.TestConnection();
        LoadIntegrationStatus();
        testing = false;
    }
}
