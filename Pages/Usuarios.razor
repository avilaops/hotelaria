@page "/usuarios"
@inject AuthService AuthService
@inject NavigationManager NavigationManager

<PageTitle>Gest√£o de Usu√°rios - Hotelaria</PageTitle>

<div class="page-header">
    <h1>üë• Gest√£o de Usu√°rios</h1>
    <div class="header-actions">
        <button class="btn btn-primary" @onclick="() => AbrirModal(null)">
            ‚ûï Novo Usu√°rio
        </button>
    </div>
</div>

<!-- Filtros e Busca -->
<div class="filters-section">
    <div class="filter-group search">
        <label>Buscar:</label>
        <input type="text" @bind="TermoBusca" placeholder="Nome, usu√°rio ou email..." class="form-control" />
    </div>
    
    <div class="filter-group">
        <label>Perfil:</label>
        <select @bind="PerfilFiltro" class="form-control">
            <option value="">Todos</option>
            @foreach (var perfil in Enum.GetValues<PerfilUsuario>())
            {
                <option value="@perfil">@AuthService.ObterNomePerfil(perfil)</option>
            }
        </select>
    </div>
</div>

<!-- Lista de Usu√°rios -->
<div class="usuarios-grid">
    @if (usuariosFiltrados.Any())
    {
        @foreach (var usuario in usuariosFiltrados)
        {
            <div class="usuario-card @(usuario.Ativo ? "" : "inativo")">
                <div class="usuario-avatar">
                    @if (!string.IsNullOrEmpty(usuario.Foto))
                    {
                        <img src="@usuario.Foto" alt="@usuario.Nome" />
                    }
                    else
                    {
                        <div class="avatar-placeholder">
                            @GetIniciais(usuario.Nome)
                        </div>
                    }
                </div>

                <div class="usuario-info">
                    <h3>@usuario.Nome</h3>
                    <p class="username">@@@usuario.Username</p>
                    <p class="email">@usuario.Email</p>
                    
                    <div class="usuario-badges">
                        <span class="badge perfil-@usuario.Perfil.ToString().ToLower()">
                            @AuthService.ObterNomePerfil(usuario.Perfil)
                        </span>
                        @if (!usuario.Ativo)
                        {
                            <span class="badge badge-inactive">Inativo</span>
                        }
                        @if (usuario.Id == AuthService.ObterUsuarioAtual()?.Id)
                        {
                            <span class="badge badge-current">Voc√™</span>
                        }
                    </div>

                    <div class="usuario-meta">
                        <span class="meta-item">
                            <span class="icon">üìÖ</span>
                            Criado: @usuario.DataCriacao.ToString("dd/MM/yyyy")
                        </span>
                        @if (usuario.UltimoAcesso.HasValue)
                        {
                            <span class="meta-item">
                                <span class="icon">üïí</span>
                                √öltimo acesso: @usuario.UltimoAcesso.Value.ToString("dd/MM/yyyy HH:mm")
                            </span>
                        }
                    </div>
                </div>

                <div class="usuario-actions">
                    <button class="btn btn-sm btn-secondary" @onclick="() => AbrirModal(usuario)">
                        ‚úèÔ∏è Editar
                    </button>
                    @if (usuario.Id != AuthService.ObterUsuarioAtual()?.Id)
                    {
                        <button class="btn btn-sm btn-danger" @onclick="() => ExcluirUsuario(usuario)">
                            üóëÔ∏è Excluir
                        </button>
                    }
                </div>
            </div>
        }
    }
    else
    {
        <div class="no-data">
            <p>üòî Nenhum usu√°rio encontrado.</p>
        </div>
    }
</div>

<!-- Modal de Criar/Editar Usu√°rio -->
@if (mostrarModal)
{
    <div class="modal-overlay" @onclick="FecharModal">
        <div class="modal-content large" @onclick:stopPropagation="true">
            <div class="modal-header">
                <h2>@(usuarioEdicao.Id == 0 ? "‚ûï Novo Usu√°rio" : "‚úèÔ∏è Editar Usu√°rio")</h2>
                <button class="btn-close" @onclick="FecharModal">‚úñ</button>
            </div>

            <div class="modal-body">
                @if (!string.IsNullOrEmpty(mensagemErro))
                {
                    <div class="alert alert-error">
                        <span class="icon">‚ö†Ô∏è</span>
                        <span>@mensagemErro</span>
                    </div>
                }

                <div class="form-row">
                    <div class="form-group">
                        <label>Nome Completo:</label>
                        <input type="text" @bind="usuarioEdicao.Nome" class="form-control" placeholder="Nome completo" />
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label>Nome de Usu√°rio:</label>
                        <input type="text" @bind="usuarioEdicao.Username" class="form-control" placeholder="username" />
                    </div>
                    <div class="form-group">
                        <label>Email:</label>
                        <input type="email" @bind="usuarioEdicao.Email" class="form-control" placeholder="email@exemplo.com" />
                    </div>
                </div>

                @if (usuarioEdicao.Id == 0)
                {
                    <div class="form-row">
                        <div class="form-group">
                            <label>Senha:</label>
                            <input type="password" @bind="novaSenha" class="form-control" placeholder="Digite a senha" />
                        </div>
                        <div class="form-group">
                            <label>Confirmar Senha:</label>
                            <input type="password" @bind="confirmarSenha" class="form-control" placeholder="Confirme a senha" />
                        </div>
                    </div>
                }

                <div class="form-row">
                    <div class="form-group">
                        <label>Perfil:</label>
                        <select @bind="usuarioEdicao.Perfil" class="form-control">
                            @foreach (var perfil in Enum.GetValues<PerfilUsuario>())
                            {
                                <option value="@perfil">@AuthService.ObterNomePerfil(perfil)</option>
                            }
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Status:</label>
                        <select @bind="usuarioEdicao.Ativo" class="form-control">
                            <option value="true">Ativo</option>
                            <option value="false">Inativo</option>
                        </select>
                    </div>
                </div>

                @if (usuarioEdicao.Id != 0)
                {
                    <div class="form-group">
                        <button class="btn btn-secondary btn-sm" @onclick="() => mostrarAlterarSenha = !mostrarAlterarSenha">
                            üîí Redefinir Senha
                        </button>
                    </div>

                    @if (mostrarAlterarSenha)
                    {
                        <div class="form-row">
                            <div class="form-group">
                                <label>Nova Senha:</label>
                                <input type="password" @bind="novaSenha" class="form-control" placeholder="Nova senha" />
                            </div>
                            <div class="form-group">
                                <label>Confirmar Senha:</label>
                                <input type="password" @bind="confirmarSenha" class="form-control" placeholder="Confirme a senha" />
                            </div>
                        </div>
                    }
                }
            </div>

            <div class="modal-footer">
                <button class="btn btn-secondary" @onclick="FecharModal">Cancelar</button>
                <button class="btn btn-primary" @onclick="SalvarUsuario">üíæ Salvar</button>
            </div>
        </div>
    </div>
}

@code {
    private List<Usuario> usuariosFiltrados = new();
    private string termoBusca = string.Empty;
    private string perfilFiltro = string.Empty;

    private string TermoBusca
    {
        get => termoBusca;
        set
        {
            termoBusca = value;
            BuscarUsuarios();
        }
    }

    private string PerfilFiltro
    {
        get => perfilFiltro;
        set
        {
            perfilFiltro = value;
            FiltrarUsuarios();
        }
    }

    private bool mostrarModal = false;
    private Usuario usuarioEdicao = new();
    private string novaSenha = string.Empty;
    private string confirmarSenha = string.Empty;
    private bool mostrarAlterarSenha = false;
    private string mensagemErro = string.Empty;

    protected override void OnInitialized()
    {
        // Verificar se est√° autenticado e tem permiss√£o
        if (!AuthService.EstaAutenticado())
        {
            NavigationManager.NavigateTo("/login");
            return;
        }

        if (!AuthService.TemPermissao(PerfilUsuario.Gerente))
        {
            NavigationManager.NavigateTo("/");
            return;
        }

        CarregarUsuarios();
    }

    private void CarregarUsuarios()
    {
        usuariosFiltrados = AuthService.ObterTodos().OrderBy(u => u.Nome).ToList();
    }

    private void BuscarUsuarios()
    {
        if (string.IsNullOrWhiteSpace(termoBusca))
        {
            CarregarUsuarios();
        }
        else
        {
            usuariosFiltrados = AuthService.BuscarUsuarios(termoBusca);
        }

        FiltrarPorPerfil();
        StateHasChanged();
    }

    private void FiltrarUsuarios()
    {
        BuscarUsuarios();
    }

    private void FiltrarPorPerfil()
    {
        if (!string.IsNullOrWhiteSpace(perfilFiltro) && Enum.TryParse<PerfilUsuario>(perfilFiltro, out var perfil))
        {
            usuariosFiltrados = usuariosFiltrados.Where(u => u.Perfil == perfil).ToList();
        }
    }

    private void AbrirModal(Usuario? usuario)
    {
        mensagemErro = string.Empty;
        novaSenha = string.Empty;
        confirmarSenha = string.Empty;
        mostrarAlterarSenha = false;

        if (usuario == null)
        {
            usuarioEdicao = new Usuario
            {
                Perfil = PerfilUsuario.Recepcionista,
                Ativo = true
            };
        }
        else
        {
            usuarioEdicao = new Usuario
            {
                Id = usuario.Id,
                Nome = usuario.Nome,
                Email = usuario.Email,
                Username = usuario.Username,
                SenhaHash = usuario.SenhaHash,
                Perfil = usuario.Perfil,
                Ativo = usuario.Ativo,
                DataCriacao = usuario.DataCriacao,
                UltimoAcesso = usuario.UltimoAcesso
            };
        }

        mostrarModal = true;
    }

    private void FecharModal()
    {
        mostrarModal = false;
        usuarioEdicao = new();
        mensagemErro = string.Empty;
    }

    private void SalvarUsuario()
    {
        mensagemErro = string.Empty;

        // Valida√ß√µes
        if (string.IsNullOrWhiteSpace(usuarioEdicao.Nome))
        {
            mensagemErro = "Nome √© obrigat√≥rio";
            return;
        }

        if (string.IsNullOrWhiteSpace(usuarioEdicao.Username))
        {
            mensagemErro = "Nome de usu√°rio √© obrigat√≥rio";
            return;
        }

        if (string.IsNullOrWhiteSpace(usuarioEdicao.Email))
        {
            mensagemErro = "Email √© obrigat√≥rio";
            return;
        }

        // Validar senha apenas para novo usu√°rio
        if (usuarioEdicao.Id == 0)
        {
            if (string.IsNullOrWhiteSpace(novaSenha))
            {
                mensagemErro = "Senha √© obrigat√≥ria";
                return;
            }

            if (novaSenha != confirmarSenha)
            {
                mensagemErro = "As senhas n√£o conferem";
                return;
            }

            if (novaSenha.Length < 6)
            {
                mensagemErro = "A senha deve ter no m√≠nimo 6 caracteres";
                return;
            }

            usuarioEdicao.SenhaHash = AuthService.HashSenha(novaSenha);
        }
        else if (mostrarAlterarSenha)
        {
            // Redefinir senha de usu√°rio existente
            if (!string.IsNullOrWhiteSpace(novaSenha))
            {
                if (novaSenha != confirmarSenha)
                {
                    mensagemErro = "As senhas n√£o conferem";
                    return;
                }

                if (novaSenha.Length < 6)
                {
                    mensagemErro = "A senha deve ter no m√≠nimo 6 caracteres";
                    return;
                }

                AuthService.RedefinirSenha(usuarioEdicao.Id, novaSenha);
            }
        }

        bool sucesso;
        if (usuarioEdicao.Id == 0)
        {
            sucesso = AuthService.AdicionarUsuario(usuarioEdicao);
            if (!sucesso)
            {
                mensagemErro = "Nome de usu√°rio j√° existe";
                return;
            }
        }
        else
        {
            sucesso = AuthService.AtualizarUsuario(usuarioEdicao);
            if (!sucesso)
            {
                mensagemErro = "Erro ao atualizar usu√°rio";
                return;
            }
        }

        FecharModal();
        CarregarUsuarios();
    }

    private void ExcluirUsuario(Usuario usuario)
    {
        if (confirm($"Deseja realmente excluir o usu√°rio {usuario.Nome}?"))
        {
            var sucesso = AuthService.RemoverUsuario(usuario.Id);
            if (sucesso)
            {
                CarregarUsuarios();
            }
        }
    }

    private bool confirm(string message)
    {
        // Em produ√ß√£o, usar JS Interop para confirm
        return true;
    }

    private string GetIniciais(string nome)
    {
        var partes = nome.Split(' ', StringSplitOptions.RemoveEmptyEntries);
        if (partes.Length == 0) return "?";
        if (partes.Length == 1) return partes[0].Substring(0, Math.Min(2, partes[0].Length)).ToUpper();
        return $"{partes[0][0]}{partes[^1][0]}".ToUpper();
    }
}
