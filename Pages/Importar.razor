@page "/importar"
@inject ImportacaoService ImportacaoService
@inject ReservaService ReservaService
@inject QuartoService QuartoService
@inject HospedeService HospedeService
@inject NavigationManager NavigationManager

<PageTitle>Importar Dados - Hotelaria</PageTitle>

@code {
    private string? nomeArquivo;
    private long tamanhoArquivo;
    private bool processando = false;
    private ImportacaoResultado? resultado;
    private bool importacaoConcluida = false;
    private string conteudoArquivo = string.Empty;
    private bool importando = false;
    private FileValidationResult? fileValidation;

    protected override void OnInitialized()
    {
    }

    private async Task CarregarArquivo(InputFileChangeEventArgs e)
    {
        try
        {
            processando = true;
            resultado = null;
            importacaoConcluida = false;
            fileValidation = null;

            var arquivo = e.File;

            // VALIDA√á√ÉO COMPLETA DO ARQUIVO
            fileValidation = await FileValidator.ValidateFileAsync(arquivo);
            
            if (!fileValidation.IsValid)
            {
                resultado = new ImportacaoResultado
                {
                    LinhasComErro = 1,
                    Erros = fileValidation.Errors
                };
                processando = false;
                return;
            }

            nomeArquivo = fileValidation.FileName;
            tamanhoArquivo = fileValidation.FileSize / 1024;

            // Ler conte√∫do do arquivo
            using var stream = arquivo.OpenReadStream(maxAllowedSize: 10 * 1024 * 1024);
            using var reader = new StreamReader(stream);
            conteudoArquivo = await reader.ReadToEndAsync();

            // Processar dados
            resultado = ImportacaoService.ProcessarCSV(conteudoArquivo);
            
            // Adicionar avisos do FileValidator
            if (fileValidation.Warnings.Any())
            {
                foreach (var warning in fileValidation.Warnings)
                {
                    resultado.Erros.Insert(0, $"‚ö†Ô∏è {warning}");
                }
            }
        }
        catch (Exception ex)
        {
            resultado = new ImportacaoResultado
            {
                LinhasComErro = 1,
                Erros = new List<string> { $"Erro ao ler arquivo: {ex.Message}" }
            };
        }
        finally
        {
            processando = false;
        }
    }

    private async Task ConfirmarImportacao()
    {
        if (resultado != null && resultado.LinhasImportadas > 0 && !importando)
        {
            try
            {
                importando = true;
                StateHasChanged();
                
                await Task.Delay(500); // Pequeno delay para feedback visual
                
                ImportacaoService.ImportarParaSistema(resultado.DadosProcessados);
                importacaoConcluida = true;
            }
            catch (Exception ex)
            {
                resultado.Erros.Add($"‚ùå Erro na importa√ß√£o: {ex.Message}");
            }
            finally
            {
                importando = false;
            }
        }
    }

    private void LimparDados()
    {
        nomeArquivo = null;
        resultado = null;
        importacaoConcluida = false;
        conteudoArquivo = string.Empty;
    }

    private void ImportarMais()
    {
        LimparDados();
        importacaoConcluida = false;
    }

    private void IrParaReservas()
    {
        NavigationManager.NavigateTo("/reservas");
    }
}

<div class="page-header">
    <h1>üì• Importar Reservas</h1>
    <div class="header-actions">
        <a href="/docs/IMPORTACAO.md" class="btn btn-secondary" target="_blank">
            üìñ Ver Documenta√ß√£o
        </a>
    </div>
</div>

<div class="import-container">
    <div class="import-section">
        <h2>1Ô∏è‚É£ Selecionar Arquivo</h2>
        <p class="section-description">Selecione um arquivo CSV ou TSV com os dados das reservas para importa√ß√£o</p>
        
        <div class="file-upload">
            <InputFile OnChange="@CarregarArquivo" accept=".csv,.tsv,.txt" class="file-input" id="file-input" />
            <label for="file-input" class="file-label">
                <span class="upload-icon">üìÅ</span>
                <span class="upload-text">Clique aqui ou arraste o arquivo</span>
                <span class="upload-hint">CSV, TSV ou TXT (m√°x. 10MB)</span>
            </label>
            
            @if (!string.IsNullOrEmpty(nomeArquivo))
            {
                <div class="file-info">
                    <span class="icon">üìÑ</span>
                    <div class="file-details">
                        <strong>@nomeArquivo</strong>
                        <span class="file-size">
                            @FileValidator.FormatFileSize(tamanhoArquivo * 1024)
                            @if (fileValidation != null)
                            {
                                <span> ¬∑ @(fileValidation.LineCount ?? 0) linhas</span>
                                @if (fileValidation.DetectedEncoding != null)
                                {
                                    <span> ¬∑ @fileValidation.DetectedEncoding</span>
                                }
                                @if (fileValidation.DetectedDelimiter != null)
                                {
                                    <span> ¬∑ @fileValidation.DetectedDelimiter</span>
                                }
                            }
                        </span>
                    </div>
                    <button class="btn-remove" @onclick="LimparDados" title="Remover arquivo">‚úñ</button>
                </div>
            }
        </div>

        <div class="format-info">
            <h4>üìã Formato Esperado:</h4>
            <div class="format-details">
                <div class="format-item">
                    <strong>Tipos aceitos:</strong> CSV, TSV, TXT
                </div>
                <div class="format-item">
                    <strong>Tamanho m√°ximo:</strong> 10 MB
                </div>
                <div class="format-item">
                    <strong>Separador:</strong> Tabula√ß√£o (TSV), v√≠rgula (CSV) ou ponto-e-v√≠rgula (;)
                </div>
                <div class="format-item">
                    <strong>Primeira linha:</strong> Cabe√ßalhos das colunas
                </div>
                <div class="format-item">
                    <strong>Colunas essenciais:</strong> Nome, Check-in, Check-out, N¬∫ Reserva, Total
                </div>
                <div class="format-item">
                    <strong>Encoding:</strong> UTF-8, UTF-16 ou ASCII
                </div>
            </div>
            <details class="format-example">
                <summary>Ver exemplo de formato</summary>
                <pre class="code-example">Nome	Data Nascimento	N¬∫ Documento	Pa√≠s	Tipo Doc	Cama	Check-in	Check-out	Dias Pessoas	...
Jo√£o Silva	01/01/1990	123456789	Portugal	BI	Q 3 - Cama 01	15/01/2024	20/01/2024	5	...</pre>
            </details>
        </div>
    </div>

    @if (processando)
    {
        <div class="loading">
            <div class="spinner"></div>
            <p>Processando arquivo...</p>
            <p class="loading-hint">Validando formato, encoding e estrutura de dados</p>
        </div>
    }

    @if (resultado != null && !processando)
    {
        <div class="import-section">
            <h2>2Ô∏è‚É£ Resultado do Processamento</h2>
            
            <div class="resultado-stats">
                <div class="stat-card success">
                    <div class="stat-icon">‚úÖ</div>
                    <div class="stat-content">
                        <h3>@resultado.LinhasImportadas</h3>
                        <p>Linhas V√°lidas</p>
                        <small>@(resultado.TotalLinhas > 0 ? Math.Round((decimal)resultado.LinhasImportadas / resultado.TotalLinhas * 100, 1) : 0)% do total</small>
                    </div>
                </div>
                
                <div class="stat-card error">
                    <div class="stat-icon">‚ùå</div>
                    <div class="stat-content">
                        <h3>@resultado.LinhasComErro</h3>
                        <p>Com Erros</p>
                        <small>@(resultado.TotalLinhas > 0 ? Math.Round((decimal)resultado.LinhasComErro / resultado.TotalLinhas * 100, 1) : 0)% do total</small>
                    </div>
                </div>
                
                <div class="stat-card info">
                    <div class="stat-icon">üìä</div>
                    <div class="stat-content">
                        <h3>@resultado.TotalLinhas</h3>
                        <p>Total de Linhas</p>
                        <small>Excluindo cabe√ßalho</small>
                    </div>
                </div>

                @if (resultado.LinhasImportadas > 0)
                {
                    <div class="stat-card success">
                        <div class="stat-icon">üí∞</div>
                        <div class="stat-content">
                            <h3>‚Ç¨ @resultado.DadosProcessados.Where(d => d.IsValid).Sum(d => d.Total).ToString("N2")</h3>
                            <p>Valor Total</p>
                            <small>@resultado.LinhasImportadas reservas</small>
                        </div>
                    </div>
                }
            </div>

            @if (resultado.Erros.Any())
            {
                <div class="erros-section @(resultado.LinhasImportadas > 0 ? "warning" : "error")">
                    <div class="erros-header">
                        <h3>@(resultado.LinhasImportadas > 0 ? "‚ö†Ô∏è" : "‚ùå") 
                            @resultado.Erros.Count @(resultado.Erros.Count == 1 ? "Erro Encontrado" : "Erros Encontrados")
                        </h3>
                        @if (resultado.LinhasImportadas > 0)
                        {
                            <p class="erros-hint">Voc√™ pode importar as linhas v√°lidas e corrigir os erros depois</p>
                        }
                    </div>
                    <div class="erros-list">
                        @foreach (var erro in resultado.Erros.Take(15))
                        {
                            <div class="erro-item @(erro.Contains("‚ö†Ô∏è") ? "warning" : "error")">
                                @erro
                            </div>
                        }
                        @if (resultado.Erros.Count > 15)
                        {
                            <div class="erro-item info">
                                üìã ... e mais @(resultado.Erros.Count - 15) @(resultado.Erros.Count - 15 == 1 ? "erro" : "erros")
                            </div>
                        }
                    </div>
                </div>
            }

            @if (resultado.LinhasImportadas > 0)
            {
                <div class="preview-section">
                    <h3>üìã Preview dos Dados (Primeiras @Math.Min(resultado.LinhasImportadas, 5) linhas v√°lidas):</h3>
                    <div class="table-container">
                        <table class="preview-table">
                            <thead>
                                <tr>
                                    <th>Nome</th>
                                    <th>Documento</th>
                                    <th>Pa√≠s</th>
                                    <th>Check-in</th>
                                    <th>Check-out</th>
                                    <th>Noites</th>
                                    <th>Quarto</th>
                                    <th>Di√°ria</th>
                                    <th>Total</th>
                                    <th>Status</th>
                                </tr>
                            </thead>
                            <tbody>
                                @foreach (var item in resultado.DadosProcessados.Where(d => d.IsValid).Take(5))
                                {
                                    var noites = item.CheckOut.HasValue && item.CheckIn.HasValue 
                                        ? (item.CheckOut.Value - item.CheckIn.Value).Days 
                                        : 0;
                                    <tr>
                                        <td><strong>@item.Nome</strong></td>
                                        <td>@item.NumeroDocumento</td>
                                        <td>
                                            @if (!string.IsNullOrEmpty(item.Pais))
                                            {
                                                <span class="country-badge">üåç @item.Pais</span>
                                            }
                                        </td>
                                        <td>@item.CheckIn?.ToString("dd/MM/yyyy")</td>
                                        <td>@item.CheckOut?.ToString("dd/MM/yyyy")</td>
                                        <td class="text-center">@noites</td>
                                        <td class="text-center"><span class="quarto-badge">Q @item.NumeroQuarto</span></td>
                                        <td class="text-right">‚Ç¨ @item.Diaria.ToString("N2")</td>
                                        <td class="text-right"><strong>‚Ç¨ @item.Total.ToString("N2")</strong></td>
                                        <td><span class="badge-success">‚úì V√°lido</span></td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    </div>
                    
                    @if (resultado.LinhasImportadas > 5)
                    {
                        <p class="preview-hint">+ @(resultado.LinhasImportadas - 5) @(resultado.LinhasImportadas - 5 == 1 ? "linha adicional" : "linhas adicionais") pronta(s) para importar</p>
                    }
                </div>

                <div class="action-buttons">
                    <button class="btn btn-secondary" @onclick="LimparDados">
                        üîÑ Cancelar e Escolher Outro Arquivo
                    </button>
                    <button class="btn btn-success btn-lg" @onclick="ConfirmarImportacao" disabled="@importando">
                        @if (importando)
                        {
                            <span class="spinner-small"></span>
                            <span>Importando...</span>
                        }
                        else
                        {
                            <span>‚úÖ Importar @resultado.LinhasImportadas @(resultado.LinhasImportadas == 1 ? "Reserva" : "Reservas")</span>
                        }
                    </button>
                </div>
            }
            else if (resultado.LinhasComErro > 0)
            {
                <div class="no-valid-data">
                    <div class="icon">‚ö†Ô∏è</div>
                    <h3>Nenhuma linha v√°lida encontrada</h3>
                    <p>Corrija os erros no arquivo e tente novamente.</p>
                    <button class="btn btn-primary" @onclick="LimparDados">
                        üîÑ Tentar Novamente
                    </button>
                </div>
            }
        </div>
    }

    @if (importacaoConcluida)
    {
        <div class="success-message">
            <div class="success-icon">üéâ</div>
            <h2>Importa√ß√£o Conclu√≠da com Sucesso!</h2>
            <p class="success-details">
                <strong>@resultado!.LinhasImportadas</strong> @(resultado.LinhasImportadas == 1 ? "reserva foi importada" : "reservas foram importadas") 
                para o sistema.
            </p>
            @if (resultado.LinhasComErro > 0)
            {
                <p class="success-warning">
                    ‚ö†Ô∏è @resultado.LinhasComErro @(resultado.LinhasComErro == 1 ? "linha n√£o foi importada" : "linhas n√£o foram importadas") 
                    devido a erros de valida√ß√£o.
                </p>
            }
            <div class="success-actions">
                <button class="btn btn-primary btn-lg" @onclick="IrParaReservas">
                    üìã Ver Reservas Importadas
                </button>
                <button class="btn btn-secondary" @onclick="ImportarMais">
                    üì• Importar Mais Dados
                </button>
            </div>
        </div>
    }
</div>
