@page "/login"
@inject AuthService AuthService
@inject NavigationManager NavigationManager
@inject IJSRuntime JSRuntime
@inject IConfiguration Configuration

<PageTitle>Login - Hotelaria</PageTitle>

<div class="login-container">
    <div class="login-content">
        <!-- Logo e Header Minimalista -->
        <div class="login-brand">
            <div class="brand-icon">
                <svg width="48" height="48" viewBox="0 0 48 48" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M8 40V16L24 8L40 16V40H28V28H20V40H8Z" fill="currentColor"/>
                </svg>
            </div>
            <h1>Hotelaria</h1>
        </div>

        <!-- Formul√°rio Minimalista -->
        <div class="login-form">
            @if (!string.IsNullOrEmpty(mensagemErro))
            {
                <div class="alert-minimal">
                    <svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor">
                        <path d="M8 0C3.6 0 0 3.6 0 8s3.6 8 8 8 8-3.6 8-8-3.6-8-8-8zm1 12H7V7h2v5zm0-6H7V4h2v2z"/>
                    </svg>
                    <span>@mensagemErro</span>
                </div>
            }

            @if (tentativasRestantes < 5 && tentativasRestantes > 0)
            {
                <div class="alert-warning-minimal">
                    <span>@GetTentativasMessage()</span>
                </div>
            }

            @if (bloqueadoAte.HasValue)
            {
                <div class="alert-danger-minimal">
                    <span>@GetBloqueioMessage()</span>
                </div>
            }

            <div class="input-group">
                <input type="text" 
                       @bind="loginModel.Username" 
                       @bind:event="oninput"
                       @onkeydown="HandleKeyDown"
                       placeholder="Usu√°rio"
                       class="input-minimal"
                       disabled="@bloqueadoAte.HasValue"
                       autofocus />
            </div>

            <div class="input-group">
                <input type="password" 
                       @bind="loginModel.Senha" 
                       @bind:event="oninput"
                       @onkeydown="HandleKeyDown"
                       placeholder="Senha"
                       disabled="@bloqueadoAte.HasValue"
                       class="input-minimal" />
            </div>

            <button class="btn-primary-minimal" 
                    @onclick="RealizarLogin" 
                    disabled="@(processando || bloqueadoAte.HasValue)">
                @if (processando)
                {
                    <span class="spinner-minimal"></span>
                }
                else
                {
                    <span>Entrar</span>
                }
            </button>

            <label class="checkbox-minimal">
                <input type="checkbox" @bind="loginModel.LembrarMe" />
                <span>Permanecer conectado</span>
            </label>
        </div>

        @if (isDevelopment)
        {
            <div class="test-credentials">
                <div class="credentials-header">
                    <svg width="12" height="12" viewBox="0 0 12 12" fill="currentColor">
                        <path d="M6 0C2.7 0 0 2.7 0 6s2.7 6 6 6 6-2.7 6-6-2.7-6-6-6zm.5 9.5h-1V5h1v4.5zm0-5.5h-1V3h1v1z"/>
                    </svg>
                    <span>Credenciais de teste (DEV)</span>
                </div>
                <div class="credentials-list">
                    <div class="credential">
                        <span class="role">Desenvolvedor</span>
                        <span class="separator">¬∑</span>
                        <code>nicolasrosaab / 7Aciqgr7@@</code>
                    </div>
                    <div class="credential">
                        <span class="role">Admin</span>
                        <span class="separator">¬∑</span>
                        <code>admin / admin123</code>
                    </div>
                    <div class="credential">
                        <span class="role">Gerente</span>
                        <span class="separator">¬∑</span>
                        <code>maria / maria123</code>
                    </div>
                    <div class="credential">
                        <span class="role">Recepcionista</span>
                        <span class="separator">¬∑</span>
                        <code>joao / joao123</code>
                    </div>
                </div>
            </div>
        }
    </div>

    <!-- Footer Minimalista -->
    <div class="login-footer">
        <span>¬© 2026 Hotelaria</span>
        <span class="separator">¬∑</span>
        <span>v2.6.0</span>
    </div>
</div>

@code {
    private LoginModel loginModel = new();
    private string mensagemErro = string.Empty;
    private bool processando = false;
    private bool isDevelopment = false;
    private int tentativasRestantes = 5;
    private DateTime? bloqueadoAte = null;

    protected override void OnInitialized()
    {
        if (AuthService.EstaAutenticado())
        {
            NavigationManager.NavigateTo("/");
        }

        // Verificar ambiente (aceitar Development ou Production para mostrar credenciais)
        var environment = Configuration.GetValue<string>("ASPNETCORE_ENVIRONMENT");
        isDevelopment = environment == "Development" || environment == "Production"; // Mostrar em ambos para debug
        
        Console.WriteLine($"[LOGIN] Ambiente: {environment}");
        Console.WriteLine($"[LOGIN] isDevelopment: {isDevelopment}");
    }

    private string GetTentativasMessage()
    {
        var tentativasText = tentativasRestantes > 1 ? "tentativas" : "tentativa";
        var restanteText = tentativasRestantes > 1 ? "restantes" : "restante";
        return $"‚ö†Ô∏è {tentativasRestantes} {tentativasText} {restanteText}";
    }

    private string GetBloqueioMessage()
    {
        if (bloqueadoAte.HasValue)
        {
            return $"üîí Conta bloqueada at√© {bloqueadoAte.Value:HH:mm:ss}";
        }
        return string.Empty;
    }

    private async Task RealizarLogin()
    {
        try
        {
            Console.WriteLine($"[LOGIN] === IN√çCIO DO LOGIN ===");
            Console.WriteLine($"[LOGIN] Usu√°rio: {loginModel.Username}");
            
            mensagemErro = string.Empty;
            processando = true;
            StateHasChanged(); // For√ßar atualiza√ß√£o para mostrar spinner

            // Valida√ß√µes de input
            if (string.IsNullOrWhiteSpace(loginModel.Username))
            {
                Console.WriteLine($"[LOGIN] Erro: Username vazio");
                mensagemErro = "Por favor, informe o usu√°rio";
                processando = false;
                StateHasChanged();
                return;
            }

            if (string.IsNullOrWhiteSpace(loginModel.Senha))
            {
                Console.WriteLine($"[LOGIN] Erro: Senha vazia");
                mensagemErro = "Por favor, informe a senha";
                processando = false;
                StateHasChanged();
                return;
            }

            // Verificar se conta est√° bloqueada
            bloqueadoAte = AuthService.GetLockoutTime(loginModel.Username);
            if (bloqueadoAte.HasValue)
            {
                Console.WriteLine($"[LOGIN] Conta bloqueada at√©: {bloqueadoAte.Value}");
                mensagemErro = $"Conta bloqueada at√© {bloqueadoAte.Value:HH:mm:ss}";
                processando = false;
                StateHasChanged();
                return;
            }

            // Delay artificial para prevenir timing attacks
            await Task.Delay(500);

            Console.WriteLine($"[LOGIN] Chamando AuthService.Login()...");
            var sucesso = AuthService.Login(loginModel.Username, loginModel.Senha);
            Console.WriteLine($"[LOGIN] Resultado: {sucesso}");

            if (sucesso)
            {
                Console.WriteLine($"[LOGIN] ‚úÖ Login bem-sucedido!");
                
                // Salvar sess√£o no LocalStorage se "Lembrar-me" marcado
                if (loginModel.LembrarMe)
                {
                    try
                    {
                        Console.WriteLine($"[LOGIN] Salvando sess√£o...");
                        await JSRuntime.InvokeVoidAsync("sessionStorage.setItem", 
                            "hotelaria_session", 
                            Guid.NewGuid().ToString());
                    }
                    catch (Exception ex)
                    {
                        Console.WriteLine($"[LOGIN] Aviso: N√£o foi poss√≠vel salvar sess√£o: {ex.Message}");
                    }
                }

                Console.WriteLine($"[LOGIN] Redirecionando para /");
                await Task.Delay(100); // Pequeno delay antes de redirecionar
                NavigationManager.NavigateTo("/", forceLoad: true);
            }
            else
            {
                Console.WriteLine($"[LOGIN] ‚ùå Login falhou!");
                
                // Atualizar tentativas restantes
                tentativasRestantes = AuthService.GetRemainingAttempts(loginModel.Username);
                bloqueadoAte = AuthService.GetLockoutTime(loginModel.Username);

                Console.WriteLine($"[LOGIN] Tentativas restantes: {tentativasRestantes}");

                if (bloqueadoAte.HasValue)
                {
                    mensagemErro = $"Muitas tentativas. Conta bloqueada por 15 minutos.";
                }
                else if (tentativasRestantes > 0)
                {
                    mensagemErro = "Usu√°rio ou senha incorretos";
                }

                processando = false;
                StateHasChanged();
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"[LOGIN] üî• ERRO CR√çTICO: {ex.Message}");
            Console.WriteLine($"[LOGIN] Stack: {ex.StackTrace}");
            mensagemErro = $"Erro ao processar login. Tente novamente.";
            processando = false;
            StateHasChanged();
        }
        finally
        {
            Console.WriteLine($"[LOGIN] === FIM DO LOGIN ===");
        }
    }

    private async Task HandleKeyDown(KeyboardEventArgs e)
    {
        if (e.Key == "Enter" && !processando && !bloqueadoAte.HasValue)
        {
            Console.WriteLine($"[LOGIN] Enter pressionado");
            await RealizarLogin();
        }
    }
}
