@page "/login"
@inject AuthService AuthService
@inject NavigationManager NavigationManager
@inject IJSRuntime JSRuntime
@inject IConfiguration Configuration

<PageTitle>Login - Hotelaria</PageTitle>

<div class="login-container">
    <div class="login-content">
        <!-- Logo e Header Minimalista -->
        <div class="login-brand">
            <div class="brand-icon">
                <svg width="48" height="48" viewBox="0 0 48 48" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M8 40V16L24 8L40 16V40H28V28H20V40H8Z" fill="currentColor"/>
                </svg>
            </div>
            <h1>Hotelaria</h1>
        </div>

        <!-- FormulÃ¡rio Minimalista -->
        <div class="login-form">
            @if (!string.IsNullOrEmpty(mensagemErro))
            {
                <div class="alert-minimal">
                    <svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor">
                        <path d="M8 0C3.6 0 0 3.6 0 8s3.6 8 8 8 8-3.6 8-8-3.6-8-8-8zm1 12H7V7h2v5zm0-6H7V4h2v2z"/>
                    </svg>
                    <span>@mensagemErro</span>
                </div>
            }

            @if (tentativasRestantes < 5 && tentativasRestantes > 0)
            {
                <div class="alert-warning-minimal">
                    <span>âš ï¸ @tentativasRestantes tentativa@(tentativasRestantes > 1 ? "s" : "") restante@(tentativasRestantes > 1 ? "s" : "")</span>
                </div>
            }

            @if (bloqueadoAte.HasValue)
            {
                <div class="alert-danger-minimal">
                    <span>ðŸ”’ Conta bloqueada atÃ© @bloqueadoAte.Value.ToString("HH:mm:ss")</span>
                </div>
            }

            <div class="input-group">
                <input type="text" 
                       @bind="loginModel.Username" 
                       @bind:event="oninput"
                       @onkeydown="HandleKeyDown"
                       placeholder="UsuÃ¡rio"
                       class="input-minimal"
                       disabled="@bloqueadoAte.HasValue"
                       autofocus />
            </div>

            <div class="input-group">
                <input type="password" 
                       @bind="loginModel.Senha" 
                       @bind:event="oninput"
                       @onkeydown="HandleKeyDown"
                       placeholder="Senha"
                       disabled="@bloqueadoAte.HasValue"
                       class="input-minimal" />
            </div>

            <button class="btn-primary-minimal" 
                    @onclick="RealizarLogin" 
                    disabled="@(processando || bloqueadoAte.HasValue)">
                @if (processando)
                {
                    <span class="spinner-minimal"></span>
                }
                else
                {
                    <span>Entrar</span>
                }
            </button>

            <label class="checkbox-minimal">
                <input type="checkbox" @bind="loginModel.LembrarMe" />
                <span>Permanecer conectado</span>
            </label>
        </div>

        <!-- Credenciais de Teste - APENAS EM DESENVOLVIMENTO -->
        @if (isDevelopment)
        {
            <div class="test-credentials">
                <div class="credentials-header">
                    <svg width="12" height="12" viewBox="0 0 12 12" fill="currentColor">
                        <path d="M6 0C2.7 0 0 2.7 0 6s2.7 6 6 6 6-2.7 6-6-2.7-6-6-6zm.5 9.5h-1V5h1v4.5zm0-5.5h-1V3h1v1z"/>
                    </svg>
                    <span>Credenciais de teste (DEV)</span>
                </div>
                <div class="credentials-list">
                    <div class="credential">
                        <span class="role">Admin</span>
                        <span class="separator">Â·</span>
                        <code>admin / admin123</code>
                    </div>
                    <div class="credential">
                        <span class="role">Gerente</span>
                        <span class="separator">Â·</span>
                        <code>maria / maria123</code>
                    </div>
                    <div class="credential">
                        <span class="role">Recepcionista</span>
                        <span class="separator">Â·</span>
                        <code>joao / joao123</code>
                    </div>
                </div>
            </div>
        }
    </div>

    <!-- Footer Minimalista -->
    <div class="login-footer">
        <span>Â© 2026 Hotelaria</span>
        <span class="separator">Â·</span>
        <span>v2.6.0</span>
    </div>
</div>

@code {
    private LoginModel loginModel = new();
    private string mensagemErro = string.Empty;
    private bool processando = false;
    private bool isDevelopment = false;
    private int tentativasRestantes = 5;
    private DateTime? bloqueadoAte = null;

    protected override void OnInitialized()
    {
        if (AuthService.EstaAutenticado())
        {
            NavigationManager.NavigateTo("/");
        }

        // Verificar ambiente
        isDevelopment = Configuration.GetValue<string>("ASPNETCORE_ENVIRONMENT") == "Development";
    }

    private async Task RealizarLogin()
    {
        mensagemErro = string.Empty;
        processando = true;

        // ValidaÃ§Ãµes de input
        if (string.IsNullOrWhiteSpace(loginModel.Username))
        {
            mensagemErro = "Por favor, informe o usuÃ¡rio";
            processando = false;
            return;
        }

        if (string.IsNullOrWhiteSpace(loginModel.Senha))
        {
            mensagemErro = "Por favor, informe a senha";
            processando = false;
            return;
        }

        // Verificar se conta estÃ¡ bloqueada
        bloqueadoAte = AuthService.GetLockoutTime(loginModel.Username);
        if (bloqueadoAte.HasValue)
        {
            mensagemErro = $"Conta bloqueada atÃ© {bloqueadoAte.Value:HH:mm:ss}";
            processando = false;
            return;
        }

        await Task.Delay(500); // Delay artificial para prevenir timing attacks

        var sucesso = AuthService.Login(loginModel.Username, loginModel.Senha);

        if (sucesso)
        {
            // Salvar sessÃ£o no LocalStorage se "Lembrar-me" marcado
            if (loginModel.LembrarMe)
            {
                await JSRuntime.InvokeVoidAsync("SessionManager.setSession", 
                    Guid.NewGuid().ToString(), 60); // 60 minutos
            }

            NavigationManager.NavigateTo("/", forceLoad: true);
        }
        else
        {
            // Atualizar tentativas restantes
            tentativasRestantes = AuthService.GetRemainingAttempts(loginModel.Username);
            bloqueadoAte = AuthService.GetLockoutTime(loginModel.Username);

            if (bloqueadoAte.HasValue)
            {
                mensagemErro = $"Muitas tentativas. Conta bloqueada por 15 minutos.";
            }
            else if (tentativasRestantes > 0)
            {
                mensagemErro = "UsuÃ¡rio ou senha incorretos";
            }

            processando = false;
        }
    }

    private async Task HandleKeyDown(KeyboardEventArgs e)
    {
        if (e.Key == "Enter" && !processando && !bloqueadoAte.HasValue)
        {
            await RealizarLogin();
        }
    }
}
