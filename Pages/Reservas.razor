@page "/reservas"
@inject ReservaService ReservaService
@inject QuartoService QuartoService
@inject HospedeService HospedeService
@inject NavigationManager NavigationManager

<PageTitle>Reservas - Hotelaria</PageTitle>

<AjudaComponent ModuloAtual="reservas" />

<div class="page-header">
    <h1>Reservas</h1>
    <button class="btn btn-primary" @onclick="AbrirModalNovaReserva">
        ‚ûï Nova Reserva
    </button>
</div>

<div class="filters-section">
    <div class="filter-group">
        <label>Data de:</label>
        <input type="date" @bind="dataInicio" @bind:event="onchange" class="form-control" />
    </div>
    
    <div class="filter-group">
        <label>At√©:</label>
        <input type="date" @bind="dataFim" @bind:event="onchange" class="form-control" />
    </div>
    
    <div class="filter-group">
        <label>Status:</label>
        <select @onchange="FiltrarPorStatus" class="form-control">
            <option value="">Todos</option>
            <option value="@StatusReserva.Pendente">Pendente</option>
            <option value="@StatusReserva.Confirmada">Confirmada</option>
            <option value="@StatusReserva.CheckInRealizado">Check-in Realizado</option>
            <option value="@StatusReserva.CheckOutRealizado">Check-out Realizado</option>
            <option value="@StatusReserva.Cancelada">Cancelada</option>
        </select>
    </div>
    
    <div class="filter-group search">
        <label>Buscar:</label>
        <input type="text" @bind="termoBusca" @bind:event="oninput" 
               placeholder="Nome do h√≥spede ou n√∫mero da reserva" class="form-control" />
    </div>
    
    <button class="btn btn-secondary" @onclick="LimparFiltros">üîÑ Limpar</button>
    <button class="btn btn-primary" @onclick="AplicarFiltros">üîç Buscar</button>
</div>

<div class="table-container">
    <table class="reservas-table">
        <thead>
            <tr>
                <th>Nome do H√≥spede</th>
                <th>Check-in</th>
                <th>Check-out</th>
                <th>Quartos</th>
                <th>Reservado em</th>
                <th>Status</th>
                <th>Pre√ßo</th>
                <th>Comiss√£o</th>
                <th>N¬∫ Reserva</th>
                <th>A√ß√µes</th>
            </tr>
        </thead>
        <tbody>
            @foreach (var reserva in reservasFiltradas.OrderByDescending(r => r.CheckIn))
            {
                <tr class="@GetStatusRowClass(reserva.Status)">
                    <td>
                        <div class="hospede-info">
                            <strong>@reserva.Hospede?.Nome</strong>
                            <span class="guest-badge">Genius</span>
                            <div class="guest-details">@reserva.NumeroAdultos adulto@(reserva.NumeroAdultos > 1 ? "s" : "")</div>
                        </div>
                    </td>
                    <td>@reserva.CheckIn.ToString("dd 'de' MMM. 'de' yyyy", new System.Globalization.CultureInfo("pt-BR"))</td>
                    <td>@reserva.CheckOut.ToString("dd 'de' MMM. 'de' yyyy", new System.Globalization.CultureInfo("pt-BR"))</td>
                    <td>
                        <div class="quarto-info">
                            Quarto @reserva.Quarto?.Numero
                        </div>
                    </td>
                    <td>@reserva.DataReserva.ToString("dd 'de' MMM. 'de' yyyy", new System.Globalization.CultureInfo("pt-BR"))</td>
                    <td>
                        <span class="status-badge @GetStatusClass(reserva.Status)">
                            @GetStatusTexto(reserva.Status)
                            @if (reserva.TipoPagamento == TipoPagamento.TransferenciaBancaria)
                            {
                                <br/><small>Pagamento via Booking.com</small>
                            }
                        </span>
                    </td>
                    <td class="price">‚Ç¨ @reserva.ValorTotal.ToString("N2")<br/><small>Transfer√™ncia banc√°ria</small></td>
                    <td class="price">‚Ç¨ @reserva.Comissao.ToString("N2")</td>
                    <td><a href="#" class="reserva-link">@reserva.NumeroReserva</a></td>
                    <td>
                        <div class="action-buttons">
                            @if (reserva.Status == StatusReserva.Confirmada)
                            {
                                <button class="btn btn-sm btn-success" @onclick="() => RealizarCheckIn(reserva)">
                                    ‚úÖ Check-in
                                </button>
                            }
                            @if (reserva.Status == StatusReserva.CheckInRealizado)
                            {
                                <button class="btn btn-sm btn-info" @onclick="() => RealizarCheckOut(reserva)">
                                    üö™ Check-out
                                </button>
                            }
                            <button class="btn btn-sm btn-secondary" @onclick="() => EditarReserva(reserva)">
                                ‚úèÔ∏è
                            </button>
                            @if (reserva.Status != StatusReserva.Cancelada)
                            {
                                <button class="btn btn-sm btn-danger" @onclick="() => CancelarReserva(reserva)">
                                    ‚ùå
                                </button>
                            }
                        </div>
                    </td>
                </tr>
            }
        </tbody>
    </table>
    
    @if (!reservasFiltradas.Any())
    {
        <div class="no-data">
            <p>Nenhuma reserva encontrada com os filtros aplicados.</p>
        </div>
    }
</div>

@if (mostrarModal)
{
    <div class="modal-overlay" @onclick="FecharModal">
        <div class="modal-content large" @onclick:stopPropagation="true">
            <div class="modal-header">
                <h2>@(reservaEdicao.Id == 0 ? "Nova Reserva" : "Editar Reserva")</h2>
                <button class="btn-close" @onclick="FecharModal">‚úñ</button>
            </div>
            
            <div class="modal-body">
                <div class="form-row">
                    <div class="form-group">
                        <div class="form-group-header">
                            <label>H√≥spede:</label>
                            <button class="btn btn-sm btn-primary" @onclick="() => mostrarFormNovoHospede = !mostrarFormNovoHospede" 
                                    type="button" title="Novo H√≥spede">
                                ‚ûï
                            </button>
                        </div>
                        
                        @if (mostrarFormNovoHospede)
                        {
                            <div class="novo-hospede-form">
                                <h4>Cadastrar Novo H√≥spede</h4>
                                <div class="form-group">
                                    <label>Nome Completo:</label>
                                    <input type="text" @bind="novoHospede.Nome" class="form-control" placeholder="Nome completo do h√≥spede" />
                                </div>
                                <div class="form-row">
                                    <div class="form-group">
                                        <label>Email:</label>
                                        <input type="email" @bind="novoHospede.Email" class="form-control" placeholder="email@exemplo.com" />
                                    </div>
                                    <div class="form-group">
                                        <label>Telefone:</label>
                                        <input type="tel" @bind="novoHospede.Telefone" class="form-control" placeholder="+55 11 98765-4321" />
                                    </div>
                                </div>
                                <div class="form-row">
                                    <div class="form-group">
                                        <label>Documento:</label>
                                        <div class="input-with-select">
                                            <input type="text" @bind="novoHospede.Documento" class="form-control" 
                                                   placeholder="@GetPlaceholderDocumento()" />
                                            <select @bind="tipoDocumento" class="form-select-inline">
                                                <option value="CPF">CPF</option>
                                                <option value="RG">RG/ID</option>
                                                <option value="Passaporte">Passaporte</option>
                                                <option value="CNH">CNH</option>
                                            </select>
                                        </div>
                                    </div>
                                    <div class="form-group">
                                        <label>Pa√≠s:</label>
                                        <select @bind="novoHospede.Pais" class="form-control">
                                            <option value="">Selecione</option>
                                            <option value="Brasil">üáßüá∑ Brasil</option>
                                            <option value="Portugal">üáµüáπ Portugal</option>
                                            <option value="Espanha">üá™üá∏ Espanha</option>
                                            <option value="Estados Unidos">üá∫üá∏ Estados Unidos</option>
                                            <option value="Reino Unido">üá¨üáß Reino Unido</option>
                                            <option value="Fran√ßa">üá´üá∑ Fran√ßa</option>
                                            <option value="Alemanha">üá©üá™ Alemanha</option>
                                            <option value="It√°lia">üáÆüáπ It√°lia</option>
                                            <option value="Argentina">üá¶üá∑ Argentina</option>
                                            <option value="Chile">üá®üá± Chile</option>
                                            <option value="M√©xico">üá≤üáΩ M√©xico</option>
                                            <option value="Canad√°">üá®üá¶ Canad√°</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="form-actions">
                                    <button class="btn btn-sm btn-secondary" @onclick="CancelarNovoHospede" type="button">Cancelar</button>
                                    <button class="btn btn-sm btn-success" @onclick="SalvarNovoHospede" type="button">üíæ Salvar H√≥spede</button>
                                </div>
                            </div>
                        }
                        else
                        {
                            <select @bind="reservaEdicao.HospedeId" class="form-control">
                                <option value="0">Selecione um h√≥spede</option>
                                @foreach (var hospede in HospedeService.ObterTodos())
                                {
                                    <option value="@hospede.Id">@hospede.Nome - @hospede.Email</option>
                                }
                            </select>
                        }
                    </div>
                    
                    <div class="form-group">
                        <label>Quarto:</label>
                        <select @bind="reservaEdicao.QuartoId" class="form-control">
                            <option value="0">Selecione um quarto</option>
                            @foreach (var quarto in QuartoService.ObterDisponiveis())
                            {
                                <option value="@quarto.Id">Quarto @quarto.Numero - @quarto.Tipo (‚Ç¨@quarto.PrecoPorNoite/noite)</option>
                            }
                        </select>
                    </div>
                </div>
                
                <div class="form-row form-row-3">
                    <div class="form-group">
                        <label>Check-in:</label>
                        <input type="date" @bind="reservaEdicao.CheckIn" @bind:event="oninput" class="form-control" />
                    </div>
                    
                    <div class="form-group">
                        <label>Check-out:</label>
                        <input type="date" @bind="reservaEdicao.CheckOut" @bind:event="oninput" class="form-control" />
                    </div>
                    
                    <div class="form-group">
                        <label>Adultos:</label>
                        <input type="number" @bind="reservaEdicao.NumeroAdultos" class="form-control" min="1" />
                    </div>
                </div>
                
                <div class="form-row form-row-3">
                    <div class="form-group">
                        <label>Crian√ßas:</label>
                        <input type="number" @bind="reservaEdicao.NumeroCriancas" class="form-control" min="0" />
                    </div>
                    
                    <div class="form-group">
                        <label>Status:</label>
                        <select @bind="reservaEdicao.Status" class="form-control">
                            <option value="@StatusReserva.Pendente">Pendente</option>
                            <option value="@StatusReserva.Confirmada">Confirmada</option>
                            <option value="@StatusReserva.CheckInRealizado">Check-in Realizado</option>
                            <option value="@StatusReserva.CheckOutRealizado">Check-out Realizado</option>
                            <option value="@StatusReserva.Cancelada">Cancelada</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label>Tipo de Pagamento:</label>
                        <select @bind="reservaEdicao.TipoPagamento" class="form-control">
                            <option value="@TipoPagamento.TransferenciaBancaria">Transfer√™ncia Banc√°ria</option>
                            <option value="@TipoPagamento.CartaoCredito">Cart√£o de Cr√©dito</option>
                            <option value="@TipoPagamento.Dinheiro">Dinheiro</option>
                            <option value="@TipoPagamento.PIX">PIX</option>
                            <option value="@TipoPagamento.BookingCom">Booking.com</option>
                        </select>
                    </div>
                </div>
                
                <div class="form-row form-row-3">
                    <div class="form-group">
                        <label>Valor Total (‚Ç¨):</label>
                        <input type="number" step="0.01" @bind="reservaEdicao.ValorTotal" class="form-control" />
                    </div>
                    
                    <div class="form-group">
                        <label>Comiss√£o (‚Ç¨):</label>
                        <input type="number" step="0.01" @bind="reservaEdicao.Comissao" class="form-control" />
                    </div>
                    
                    <div class="form-group">
                        <label>Observa√ß√µes:</label>
                        <textarea @bind="reservaEdicao.Observacoes" class="form-control" rows="2"></textarea>
                    </div>
                </div>
            </div>
            
            <div class="modal-footer">
                <button class="btn btn-secondary" @onclick="FecharModal">Cancelar</button>
                <button class="btn btn-primary" @onclick="SalvarReserva">Salvar</button>
            </div>
        </div>
    </div>
}

@code {
    private List<Reserva> reservasFiltradas = new();
    private DateTime? dataInicio;
    private DateTime? dataFim;
    private string termoBusca = string.Empty;
    private bool mostrarModal = false;
    private Reserva reservaEdicao = new();
    private bool mostrarFormNovoHospede = false;
    private Hospede novoHospede = new();
    private string tipoDocumento = "CPF";

    protected override void OnInitialized()
    {
        dataInicio = new DateTime(2026, 1, 7);
        dataFim = new DateTime(2026, 1, 8);
        CarregarReservas();
    }

    private void CarregarReservas()
    {
        reservasFiltradas = ReservaService.ObterTodas();
    }

    private void AplicarFiltros()
    {
        reservasFiltradas = ReservaService.FiltrarPorPeriodo(dataInicio, dataFim);
        
        if (!string.IsNullOrWhiteSpace(termoBusca))
        {
            if (termoBusca.All(char.IsDigit))
            {
                reservasFiltradas = ReservaService.BuscarPorNumeroReserva(termoBusca);
            }
            else
            {
                reservasFiltradas = ReservaService.BuscarPorHospede(termoBusca);
            }
        }
    }

    private void FiltrarPorStatus(ChangeEventArgs e)
    {
        if (string.IsNullOrEmpty(e.Value?.ToString()))
        {
            CarregarReservas();
        }
        else
        {
            var status = Enum.Parse<StatusReserva>(e.Value.ToString()!);
            reservasFiltradas = ReservaService.FiltrarPorStatus(status);
        }
    }

    private void LimparFiltros()
    {
        dataInicio = null;
        dataFim = null;
        termoBusca = string.Empty;
        CarregarReservas();
    }

    private void AbrirModalNovaReserva()
    {
        reservaEdicao = new Reserva
        {
            CheckIn = DateTime.Today.AddDays(1),
            CheckOut = DateTime.Today.AddDays(2),
            DataReserva = DateTime.Now,
            Status = StatusReserva.Pendente,
            NumeroAdultos = 1,
            TipoPagamento = TipoPagamento.TransferenciaBancaria
        };
        mostrarFormNovoHospede = false;
        novoHospede = new();
        mostrarModal = true;
    }

    private void EditarReserva(Reserva reserva)
    {
        reservaEdicao = new Reserva
        {
            Id = reserva.Id,
            NumeroReserva = reserva.NumeroReserva,
            HospedeId = reserva.HospedeId,
            QuartoId = reserva.QuartoId,
            CheckIn = reserva.CheckIn,
            CheckOut = reserva.CheckOut,
            DataReserva = reserva.DataReserva,
            Status = reserva.Status,
            ValorTotal = reserva.ValorTotal,
            Comissao = reserva.Comissao,
            TipoPagamento = reserva.TipoPagamento,
            NumeroAdultos = reserva.NumeroAdultos,
            NumeroCriancas = reserva.NumeroCriancas,
            Observacoes = reserva.Observacoes
        };
        mostrarFormNovoHospede = false;
        novoHospede = new();
        mostrarModal = true;
    }

    private void SalvarNovoHospede()
    {
        if (string.IsNullOrWhiteSpace(novoHospede.Nome) || 
            string.IsNullOrWhiteSpace(novoHospede.Email))
        {
            return;
        }

        novoHospede.DataCadastro = DateTime.Now;
        HospedeService.AdicionarHospede(novoHospede);
        
        // Selecionar o h√≥spede rec√©m-criado
        reservaEdicao.HospedeId = novoHospede.Id;
        
        // Limpar e fechar formul√°rio
        mostrarFormNovoHospede = false;
        novoHospede = new();
    }

    private void CancelarNovoHospede()
    {
        mostrarFormNovoHospede = false;
        novoHospede = new();
    }

    private void CalcularValor()
    {
        if (reservaEdicao.QuartoId > 0 && reservaEdicao.CheckIn < reservaEdicao.CheckOut)
        {
            reservaEdicao.ValorTotal = ReservaService.CalcularValorTotal(
                reservaEdicao.QuartoId, 
                reservaEdicao.CheckIn, 
                reservaEdicao.CheckOut
            );
            reservaEdicao.Comissao = reservaEdicao.ValorTotal * 0.15m; // 15% de comiss√£o
        }
    }

    private void SalvarReserva()
    {
        if (reservaEdicao.HospedeId == 0 || reservaEdicao.QuartoId == 0)
        {
            return;
        }

        if (reservaEdicao.Id == 0)
        {
            ReservaService.AdicionarReserva(reservaEdicao);
        }
        else
        {
            ReservaService.AtualizarReserva(reservaEdicao);
        }
        
        FecharModal();
        CarregarReservas();
    }

    private void RealizarCheckIn(Reserva reserva)
    {
        reserva.Status = StatusReserva.CheckInRealizado;
        ReservaService.AtualizarReserva(reserva);
        
        var quarto = QuartoService.ObterPorId(reserva.QuartoId);
        if (quarto != null)
        {
            quarto.Status = StatusQuarto.Ocupado;
            QuartoService.AtualizarQuarto(quarto);
        }
        
        CarregarReservas();
    }

    private void RealizarCheckOut(Reserva reserva)
    {
        reserva.Status = StatusReserva.CheckOutRealizado;
        ReservaService.AtualizarReserva(reserva);
        
        var quarto = QuartoService.ObterPorId(reserva.QuartoId);
        if (quarto != null)
        {
            quarto.Status = StatusQuarto.Limpeza;
            QuartoService.AtualizarQuarto(quarto);
        }
        
        CarregarReservas();
    }

    private void CancelarReserva(Reserva reserva)
    {
        reserva.Status = StatusReserva.Cancelada;
        ReservaService.AtualizarReserva(reserva);
        CarregarReservas();
    }

    private void FecharModal()
    {
        mostrarModal = false;
        mostrarFormNovoHospede = false;
        reservaEdicao = new();
        novoHospede = new();
    }

    private string GetStatusClass(StatusReserva status)
    {
        return status switch
        {
            StatusReserva.Confirmada => "confirmada",
            StatusReserva.Pendente => "pendente",
            StatusReserva.CheckInRealizado => "checkin",
            StatusReserva.CheckOutRealizado => "checkout",
            StatusReserva.Cancelada => "cancelada",
            _ => ""
        };
    }

    private string GetStatusRowClass(StatusReserva status)
    {
        return status == StatusReserva.Cancelada ? "row-cancelada" : "";
    }

    private string GetStatusTexto(StatusReserva status)
    {
        return status switch
        {
            StatusReserva.Confirmada => "OK",
            StatusReserva.Pendente => "Pendente",
            StatusReserva.CheckInRealizado => "Check-in",
            StatusReserva.CheckOutRealizado => "Check-out",
            StatusReserva.Cancelada => "Cancelada",
            StatusReserva.NoShow => "No Show",
            _ => ""
        };
    }

    private string GetPlaceholderDocumento()
    {
        return tipoDocumento switch
        {
            "CPF" => "000.000.000-00",
            "RG" => "00.000.000-0",
            "Passaporte" => "AB123456",
            "CNH" => "00000000000",
            _ => "N√∫mero do documento"
        };
    }
}
