@page "/disponibilidade"
@inject QuartoService QuartoService
@inject ReservaService ReservaService
@inject HospedeService HospedeService

<PageTitle>Disponibilidade - Hotelaria</PageTitle>

<div class="page-header">
    <h1>üìÖ Disponibilidade e Calend√°rio</h1>
</div>

<div class="disponibilidade-sections">
    <!-- Se√ß√£o de Busca de Quartos -->
    <div class="search-section">
        <h2>Buscar Quartos Dispon√≠veis</h2>
        
        <div class="filters-section">
            <div class="filter-group">
                <label>Check-in:</label>
                <input type="date" @bind="dataCheckIn" class="form-control" />
            </div>
            
            <div class="filter-group">
                <label>Check-out:</label>
                <input type="date" @bind="dataCheckOut" class="form-control" />
            </div>
            
            <div class="filter-group">
                <label>H√≥spedes:</label>
                <input type="number" @bind="capacidade" class="form-control" min="1" placeholder="N¬∫ de pessoas" />
            </div>
            
            <button class="btn btn-primary" @onclick="BuscarDisponibilidade">üîç Buscar</button>
        </div>

        @if (buscaRealizada)
        {
            @if (quartosDisponiveis.Any())
            {
                <div class="quartos-grid">
                    @foreach (var quarto in quartosDisponiveis)
                    {
                        <div class="quarto-card disponivel">
                            <div class="quarto-header">
                                <h3>Quarto @quarto.Numero</h3>
                                <span class="tipo-badge @quarto.Tipo.ToString().ToLower()">@GetTipoTexto(quarto.Tipo)</span>
                            </div>
                            
                            <div class="quarto-info">
                                <div class="info-item">
                                    <span class="icon">üë•</span>
                                    <span>At√© @quarto.Capacidade pessoas</span>
                                </div>
                                <div class="info-item">
                                    <span class="icon">üí∞</span>
                                    <span class="price">‚Ç¨ @quarto.PrecoPorNoite.ToString("N2") / noite</span>
                                </div>
                            </div>
                            
                            <div class="quarto-amenities">
                                @foreach (var comodidade in quarto.Comodidades.Take(4))
                                {
                                    <span class="amenity-tag">‚úì @comodidade</span>
                                }
                                @if (quarto.Comodidades.Count > 4)
                                {
                                    <span class="amenity-tag more">+@(quarto.Comodidades.Count - 4)</span>
                                }
                            </div>
                            
                            @if (dataCheckIn != default && dataCheckOut != default && dataCheckOut > dataCheckIn)
                            {
                                var dias = (dataCheckOut - dataCheckIn).Days;
                                var total = quarto.PrecoPorNoite * dias;
                                
                                <div class="preco-total">
                                    <div class="preco-info">
                                        <span class="label">Total (@dias noite@(dias > 1 ? "s" : "")):</span>
                                        <span class="valor">‚Ç¨ @total.ToString("N2")</span>
                                    </div>
                                </div>
                            }
                        </div>
                    }
                </div>
            }
            else
            {
                <div class="no-data">
                    <p>üòî Nenhum quarto dispon√≠vel para as datas e capacidade selecionadas.</p>
                </div>
            }
        }
    </div>

    <!-- Calend√°rio de Ocupa√ß√£o -->
    <div class="calendario-section">
        <div class="calendario-header-section">
            <h2>Calend√°rio de Ocupa√ß√£o - @mesSelecionado.ToString("MMMM yyyy", new System.Globalization.CultureInfo("pt-BR"))</h2>
            
            <div class="calendario-navegacao">
                <button class="btn btn-secondary" @onclick="MesAnterior">‚Üê M√™s Anterior</button>
                <button class="btn btn-primary" @onclick="MesAtual">üìÖ Hoje</button>
                <button class="btn btn-secondary" @onclick="ProximoMes">Pr√≥ximo M√™s ‚Üí</button>
            </div>
        </div>
        
        <div class="calendario-wrapper">
            <div class="calendario-scroll">
                <table class="calendario-table">
                    <thead>
                        <tr>
                            <th class="quarto-header">Quarto</th>
                            @for (int dia = 1; dia <= DateTime.DaysInMonth(mesSelecionado.Year, mesSelecionado.Month); dia++)
                            {
                                var data = new DateTime(mesSelecionado.Year, mesSelecionado.Month, dia);
                                var diaSemana = data.ToString("ddd", new System.Globalization.CultureInfo("pt-BR")).Substring(0, 3);
                                <th class="dia-header @(data.Date == DateTime.Today ? "hoje" : "")">
                                    <div class="dia-numero">@dia</div>
                                    <div class="dia-semana">@diaSemana</div>
                                </th>
                            }
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var quarto in QuartoService.ObterTodos().OrderBy(q => q.Numero))
                        {
                            <tr>
                                <td class="quarto-cell">
                                    <div class="quarto-info-cell">
                                        <strong>@quarto.Numero</strong>
                                        <small>@GetTipoTexto(quarto.Tipo)</small>
                                    </div>
                                </td>
                                
                                @for (int dia = 1; dia <= DateTime.DaysInMonth(mesSelecionado.Year, mesSelecionado.Month); dia++)
                                {
                                    var data = new DateTime(mesSelecionado.Year, mesSelecionado.Month, dia);
                                    var reserva = ObterReservaDia(quarto.Id, data);
                                    var isInicio = reserva != null && reserva.CheckIn.Date == data;
                                    
                                    <td class="dia-cell @GetCelulaDiaClass(reserva, data, quarto.Status)" 
                                        @onclick="() => AbrirDetalhesReserva(reserva)"
                                        title="@GetCelulaTooltip(reserva, quarto.Status)"
                                        style="cursor: @(reserva != null ? "pointer" : "default")">
                                        @if (isInicio && reserva.Hospede != null)
                                        {
                                            <span class="reserva-info">
                                                @GetPrimeiroNome(reserva.Hospede.Nome)
                                            </span>
                                        }
                                    </td>
                                }
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
        </div>
        
        <div class="legenda">
            <div class="legenda-item">
                <span class="cor disponivel"></span> Dispon√≠vel
            </div>
            <div class="legenda-item">
                <span class="cor ocupado"></span> Reservado
            </div>
            <div class="legenda-item">
                <span class="cor limpeza"></span> Limpeza
            </div>
            <div class="legenda-item">
                <span class="cor manutencao"></span> Manuten√ß√£o
            </div>
            <div class="legenda-item">
                <span class="cor hoje"></span> Hoje
            </div>
        </div>
    </div>
</div>

@if (mostrarModalReserva && reservaSelecionada != null)
{
    <div class="modal-overlay" @onclick="FecharModal">
        <div class="modal-content large" @onclick:stopPropagation="true">
            <div class="modal-header">
                <h2>üìã Detalhes da Reserva</h2>
                <button class="btn-close" @onclick="FecharModal">‚úñ</button>
            </div>
            
            <div class="modal-body">
                <div class="reserva-detalhes-container">
                    <div class="detalhe-card">
                        <h3>Informa√ß√µes da Reserva</h3>
                        <div class="info-grid">
                            <div class="info-item">
                                <span class="label">N√∫mero:</span>
                                <span class="value">#@reservaSelecionada.NumeroReserva</span>
                            </div>
                            <div class="info-item">
                                <span class="label">Quarto:</span>
                                <span class="value">@reservaSelecionada.Quarto?.Numero</span>
                            </div>
                            <div class="info-item">
                                <span class="label">Check-in:</span>
                                <span class="value">@reservaSelecionada.CheckIn.ToString("dd/MM/yyyy")</span>
                            </div>
                            <div class="info-item">
                                <span class="label">Check-out:</span>
                                <span class="value">@reservaSelecionada.CheckOut.ToString("dd/MM/yyyy")</span>
                            </div>
                            <div class="info-item">
                                <span class="label">Status:</span>
                                <span class="value status-badge @GetStatusClass(reservaSelecionada.Status)">
                                    @GetStatusTexto(reservaSelecionada.Status)
                                </span>
                            </div>
                            <div class="info-item">
                                <span class="label">Valor:</span>
                                <span class="value price">‚Ç¨ @reservaSelecionada.ValorTotal.ToString("N2")</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="detalhe-card">
                        <h3>üë§ Dados do H√≥spede</h3>
                        @if (reservaSelecionada.Hospede != null)
                        {
                            <div class="form-group">
                                <label>Nome Completo:</label>
                                <input type="text" @bind="hospedeEdicao.Nome" class="form-control" />
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label>Email:</label>
                                    <input type="email" @bind="hospedeEdicao.Email" class="form-control" />
                                </div>
                                <div class="form-group">
                                    <label>Telefone:</label>
                                    <input type="tel" @bind="hospedeEdicao.Telefone" class="form-control" />
                                </div>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label>Documento:</label>
                                    <input type="text" @bind="hospedeEdicao.Documento" class="form-control" />
                                </div>
                                <div class="form-group">
                                    <label>Pa√≠s:</label>
                                    <input type="text" @bind="hospedeEdicao.Pais" class="form-control" />
                                </div>
                            </div>
                        }
                    </div>
                </div>
            </div>
            
            <div class="modal-footer">
                <button class="btn btn-secondary" @onclick="FecharModal">Cancelar</button>
                <button class="btn btn-primary" @onclick="SalvarAlteracoesHospede">üíæ Salvar Altera√ß√µes</button>
            </div>
        </div>
    </div>
}

@code {
    private List<Quarto> quartosDisponiveis = new();
    private DateTime dataCheckIn = DateTime.Today.AddDays(1);
    private DateTime dataCheckOut = DateTime.Today.AddDays(2);
    private int capacidade = 2;
    private bool buscaRealizada = false;
    
    private DateTime mesSelecionado = DateTime.Today;
    private List<Reserva> reservasMes = new();
    
    private bool mostrarModalReserva = false;
    private Reserva? reservaSelecionada;
    private Hospede hospedeEdicao = new();

    protected override void OnInitialized()
    {
        CarregarReservasMes();
    }

    private void BuscarDisponibilidade()
    {
        if (dataCheckOut > dataCheckIn)
        {
            quartosDisponiveis = QuartoService.BuscarQuartosDisponiveis(dataCheckIn, dataCheckOut, capacidade);
            buscaRealizada = true;
        }
    }

    private void CarregarReservasMes()
    {
        var inicioMes = new DateTime(mesSelecionado.Year, mesSelecionado.Month, 1);
        var fimMes = inicioMes.AddMonths(1).AddDays(-1);
        
        reservasMes = ReservaService.ObterTodas()
            .Where(r => (r.CheckIn <= fimMes && r.CheckOut >= inicioMes) && 
                   (r.Status == StatusReserva.Confirmada || r.Status == StatusReserva.CheckInRealizado))
            .ToList();
    }

    private void MesAnterior()
    {
        mesSelecionado = mesSelecionado.AddMonths(-1);
        CarregarReservasMes();
    }

    private void ProximoMes()
    {
        mesSelecionado = mesSelecionado.AddMonths(1);
        CarregarReservasMes();
    }

    private void MesAtual()
    {
        mesSelecionado = DateTime.Today;
        CarregarReservasMes();
    }

    private Reserva? ObterReservaDia(int quartoId, DateTime data)
    {
        return reservasMes.FirstOrDefault(r => 
            r.QuartoId == quartoId && 
            r.CheckIn.Date <= data && 
            r.CheckOut.Date > data);
    }

    private void AbrirDetalhesReserva(Reserva? reserva)
    {
        if (reserva != null && reserva.Hospede != null)
        {
            reservaSelecionada = reserva;
            hospedeEdicao = new Hospede
            {
                Id = reserva.Hospede.Id,
                Nome = reserva.Hospede.Nome,
                Email = reserva.Hospede.Email,
                Telefone = reserva.Hospede.Telefone,
                Documento = reserva.Hospede.Documento,
                Pais = reserva.Hospede.Pais,
                DataCadastro = reserva.Hospede.DataCadastro
            };
            mostrarModalReserva = true;
        }
    }

    private void SalvarAlteracoesHospede()
    {
        HospedeService.AtualizarHospede(hospedeEdicao);
        FecharModal();
        CarregarReservasMes();
    }

    private void FecharModal()
    {
        mostrarModalReserva = false;
        reservaSelecionada = null;
        hospedeEdicao = new();
    }

    private string GetCelulaDiaClass(Reserva? reserva, DateTime data, StatusQuarto statusQuarto)
    {
        var classes = new List<string>();
        
        if (data.Date == DateTime.Today)
            classes.Add("hoje");
        
        if (reserva != null)
            classes.Add("ocupado");
        else if (statusQuarto == StatusQuarto.Limpeza)
            classes.Add("limpeza");
        else if (statusQuarto == StatusQuarto.Manutencao)
            classes.Add("manutencao");
        else
            classes.Add("disponivel");
        
        return string.Join(" ", classes);
    }

    private string GetCelulaTooltip(Reserva? reserva, StatusQuarto statusQuarto)
    {
        if (reserva != null)
            return $"Reserva: {reserva.Hospede?.Nome} (Click para detalhes)";
        
        return statusQuarto switch
        {
            StatusQuarto.Limpeza => "Quarto em limpeza",
            StatusQuarto.Manutencao => "Quarto em manuten√ß√£o",
            _ => "Dispon√≠vel"
        };
    }

    private string GetTipoTexto(TipoQuarto tipo)
    {
        return tipo switch
        {
            TipoQuarto.Standard => "Standard",
            TipoQuarto.Deluxe => "Deluxe",
            TipoQuarto.Suite => "Su√≠te",
            TipoQuarto.Presidential => "Presidential",
            _ => ""
        };
    }

    private string GetPrimeiroNome(string? nomeCompleto)
    {
        if (string.IsNullOrEmpty(nomeCompleto))
            return "";
        
        var partes = nomeCompleto.Split(' ');
        return partes.Length > 1 ? partes[0] : nomeCompleto;
    }

    private string GetStatusTexto(StatusReserva status)
    {
        return status switch
        {
            StatusReserva.Confirmada => "Confirmada",
            StatusReserva.Pendente => "Pendente",
            StatusReserva.CheckInRealizado => "Check-in",
            StatusReserva.CheckOutRealizado => "Check-out",
            StatusReserva.Cancelada => "Cancelada",
            StatusReserva.NoShow => "No Show",
            _ => ""
        };
    }

    private string GetStatusClass(StatusReserva status)
    {
        return status switch
        {
            StatusReserva.Confirmada => "confirmada",
            StatusReserva.Pendente => "pendente",
            StatusReserva.CheckInRealizado => "checkin",
            StatusReserva.CheckOutRealizado => "checkout",
            StatusReserva.Cancelada => "cancelada",
            _ => ""
        };
    }
}
