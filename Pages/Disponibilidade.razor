@page "/disponibilidade"
@inject QuartoService QuartoService
@inject ReservaService ReservaService
@inject HospedeService HospedeService
@inject AuthService AuthService
@inject NavigationManager NavigationManager

<PageTitle>Calendário de Ocupação - Hotelaria</PageTitle>

@code {
    // ============================================
    // ESTADO DA BUSCA DE QUARTOS
    // ============================================
    private List<Quarto> quartosDisponiveis = new();
    private DateTime dataCheckIn = DateTime.Today.AddDays(1);
    private DateTime dataCheckOut = DateTime.Today.AddDays(2);
    private int capacidade = 2;
    private bool exibirResultadosBusca = false; // ✅ Renomeado de mostrarBuscaQuartos
    
    // ============================================
    // ESTADO DO CALENDÁRIO
    // ============================================
    private DateTime mesSelecionado = DateTime.Today;
    private List<Reserva> reservasMes = new();
    
    // ============================================
    // ESTADO DO MODAL DE RESERVA
    // ============================================
    private bool exibirModalReserva = false; // ✅ Renomeado de mostrarModalReserva
    private Reserva reservaEdicao = new();
    private int vagaSelecionada = 1;

    protected override void OnInitialized()
    {
        // Verificar autenticação
        if (!AuthService.EstaAutenticado())
        {
            NavigationManager.NavigateTo("/login");
            return;
        }

        // Todos os usuários autenticados podem ver disponibilidade
        // Mas apenas Recepcionista+ podem criar/editar reservas

        CarregarReservasMes();
    }

    // ============================================
    // BUSCA DE QUARTOS
    // ============================================
    private void BuscarDisponibilidade()
    {
        if (dataCheckOut > dataCheckIn)
        {
            quartosDisponiveis = QuartoService.BuscarQuartosDisponiveis(dataCheckIn, dataCheckOut, capacidade);
            exibirResultadosBusca = true; // ✅ Usar variável renomeada
        }
    }

    private void FecharResultadosBusca()
    {
        exibirResultadosBusca = false; // ✅ Usar variável renomeada
        quartosDisponiveis.Clear();
    }

    // ============================================
    // CALENDÁRIO
    // ============================================
    private void CarregarReservasMes()
    {
        var inicioMes = new DateTime(mesSelecionado.Year, mesSelecionado.Month, 1);
        var fimMes = inicioMes.AddMonths(1).AddDays(-1);
        
        reservasMes = ReservaService.ObterTodas()
            .Where(r => (r.CheckIn <= fimMes && r.CheckOut >= inicioMes) && 
                   (r.Status == StatusReserva.Confirmada || r.Status == StatusReserva.CheckInRealizado))
            .ToList();
    }

    private void MesAnterior()
    {
        mesSelecionado = mesSelecionado.AddMonths(-1);
        CarregarReservasMes();
    }

    private void ProximoMes()
    {
        mesSelecionado = mesSelecionado.AddMonths(1);
        CarregarReservasMes();
    }

    private void MesAtual()
    {
        mesSelecionado = DateTime.Today;
        CarregarReservasMes();
    }

    private Reserva? ObterReservaDia(int quartoId, DateTime data)
    {
        return reservasMes.FirstOrDefault(r => 
            r.QuartoId == quartoId && 
            r.CheckIn.Date <= data && 
            r.CheckOut.Date > data);
    }

    private Reserva? ObterReservaDiaVaga(int quartoId, DateTime data, int vaga)
    {
        return reservasMes.FirstOrDefault(r => 
            r.QuartoId == quartoId && 
            r.CheckIn.Date <= data && 
            r.CheckOut.Date > data &&
            (r.Observacoes?.Contains($"Vaga:{vaga}") ?? false));
    }

    // ============================================
    // MODAL DE RESERVA
    // ============================================
    private void AbrirDetalhesReserva(Reserva? reserva)
    {
        if (reserva != null && reserva.Hospede != null)
        {
            reservaEdicao = reserva;
            exibirModalReserva = true; // ✅ Usar variável renomeada
        }
    }

    private void FecharModalReserva()
    {
        exibirModalReserva = false; // ✅ Usar variável renomeada
        reservaEdicao = new();
        vagaSelecionada = 1;
    }

    private void ClicarCelula(Quarto quarto, DateTime data, Reserva? reserva, int vaga)
    {
        // Verificar permissão para editar
        if (!AuthService.TemPermissao(PerfilUsuario.Recepcionista))
        {
            // Visualizador não pode criar/editar
            return;
        }

        if (reserva != null)
        {
            // Editar reserva existente
            reservaEdicao = new Reserva
            {
                Id = reserva.Id,
                NumeroReserva = reserva.NumeroReserva,
                HospedeId = reserva.HospedeId,
                QuartoId = reserva.QuartoId,
                CheckIn = reserva.CheckIn,
                CheckOut = reserva.CheckOut,
                ValorTotal = reserva.ValorTotal,
                Status = reserva.Status,
                Observacoes = reserva.Observacoes,
                NumeroAdultos = reserva.NumeroAdultos,
                NumeroCriancas = reserva.NumeroCriancas
            };
            vagaSelecionada = vaga;
            exibirModalReserva = true; // ✅ Usar variável renomeada
        }
        else
        {
            // Nova reserva
            AbrirModalNovaReserva(quarto, vaga, data);
        }
    }

    private void AbrirModalNovaReserva(Quarto? quarto, int? vaga, DateTime dataInicio)
    {
        reservaEdicao = new Reserva
        {
            QuartoId = quarto?.Id ?? QuartoService.ObterTodos().First().Id,
            CheckIn = dataInicio.Date.AddHours(14), // 14h
            CheckOut = dataInicio.Date.AddDays(1).AddHours(12), // 12h do dia seguinte
            NumeroReserva = $"R{DateTime.Now:yyyyMMddHHmmss}",
            Status = StatusReserva.Confirmada,
            NumeroAdultos = 1,
            NumeroCriancas = 0,
            ValorTotal = quarto?.PrecoPorNoite ?? 20.00m
        };
        vagaSelecionada = vaga ?? 1;
        exibirModalReserva = true; // ✅ Usar variável renomeada
    }

    private void SalvarReserva()
    {
        // Adicionar informação da vaga nas observações
        if (!reservaEdicao.Observacoes?.Contains("Vaga:") ?? true)
        {
            reservaEdicao.Observacoes = $"{reservaEdicao.Observacoes} | Vaga:{vagaSelecionada}".Trim();
        }

        if (reservaEdicao.Id == 0)
        {
            ReservaService.AdicionarReserva(reservaEdicao);
        }
        else
        {
            ReservaService.AtualizarReserva(reservaEdicao);
        }

        FecharModalReserva();
        CarregarReservasMes();
    }

    private void ExcluirReserva()
    {
        if (reservaEdicao.Id != 0)
        {
            ReservaService.RemoverReserva(reservaEdicao.Id);
            FecharModalReserva();
            CarregarReservasMes();
        }
    }

    // ============================================
    // HELPERS
    // ============================================
    private Quarto? GetQuartoSelecionado()
    {
        return QuartoService.ObterPorId(reservaEdicao.QuartoId);
    }

    private string GetStatusCelula(Reserva? reserva, DateTime data, StatusQuarto statusQuarto)
    {
        if (reserva != null)
        {
            if (reserva.CheckIn.Date == data)
                return "checkin";
            if (reserva.CheckOut.Date == data)
                return "checkout";
            return "ocupado";
        }

        return statusQuarto switch
        {
            StatusQuarto.Limpeza => "limpeza",
            StatusQuarto.Manutencao => "manutencao",
            _ => "disponivel"
        };
    }

    private string GetTooltipCelula(Quarto quarto, DateTime data, Reserva? reserva, int vaga)
    {
        if (reserva != null)
        {
            var hospede = reserva.Hospede?.Nome ?? "N/A";
            var noites = (reserva.CheckOut - reserva.CheckIn).Days;
            return $"Vaga {vaga}\nReserva: {hospede}\nCheck-in: {reserva.CheckIn:dd/MM/yyyy}\nCheck-out: {reserva.CheckOut:dd/MM/yyyy}\n{noites} noite(s) - € {reserva.ValorTotal:N2}\nClique para editar";
        }

        return $"Quarto {quarto.Numero} - Vaga {vaga}\nDisponível\n€ {quarto.PrecoPorNoite:N2} / noite\nClique para reservar";
    }

    private int GetTaxaOcupacao()
    {
        var diasMes = DateTime.DaysInMonth(mesSelecionado.Year, mesSelecionado.Month);
        var totalQuartos = QuartoService.ObterTodos().Count;
        var totalDiasDisponiveis = diasMes * totalQuartos;
        
        var diasOcupados = 0;
        foreach (var reserva in reservasMes)
        {
            var inicio = reserva.CheckIn.Date < new DateTime(mesSelecionado.Year, mesSelecionado.Month, 1) 
                ? new DateTime(mesSelecionado.Year, mesSelecionado.Month, 1) 
                : reserva.CheckIn.Date;
            var fim = reserva.CheckOut.Date > new DateTime(mesSelecionado.Year, mesSelecionado.Month, diasMes)
                ? new DateTime(mesSelecionado.Year, mesSelecionado.Month, diasMes)
                : reserva.CheckOut.Date;
            
            diasOcupados += (fim - inicio).Days;
        }

        return totalDiasDisponiveis > 0 ? (int)((decimal)diasOcupados / totalDiasDisponiveis * 100) : 0;
    }

    private int GetVagasDisponiveis()
    {
        var totalVagas = QuartoService.ObterTodos().Sum(q => q.NumeroVagas);
        var vagasOcupadas = reservasMes
            .Where(r => r.CheckIn.Date <= DateTime.Today && r.CheckOut.Date > DateTime.Today)
            .Count();
        
        return totalVagas - vagasOcupadas;
    }

    private int GetVagasDisponiveisQuarto(int quartoId, DateTime checkIn, DateTime checkOut)
    {
        var quarto = QuartoService.ObterPorId(quartoId);
        if (quarto == null) return 0;

        var vagasOcupadas = ReservaService.ObterTodas()
            .Count(r => r.QuartoId == quartoId && 
                       r.CheckIn < checkOut && 
                       r.CheckOut > checkIn &&
                       r.Status != StatusReserva.Cancelada);

        return quarto.NumeroVagas - vagasOcupadas;
    }

    private int GetCheckInsHoje()
    {
        return reservasMes.Count(r => r.CheckIn.Date == DateTime.Today);
    }

    private int GetCheckOutsHoje()
    {
        return reservasMes.Count(r => r.CheckOut.Date == DateTime.Today);
    }

    private string GetTipoTexto(TipoQuarto tipo)
    {
        return tipo switch
        {
            TipoQuarto.Standard => "Standard",
            TipoQuarto.Deluxe => "Deluxe",
            TipoQuarto.Suite => "Suíte",
            TipoQuarto.Presidential => "Presidential",
            _ => ""
        };
    }

    private string GetPrimeiroNome(string? nomeCompleto)
    {
        if (string.IsNullOrEmpty(nomeCompleto))
            return "";
        
        var partes = nomeCompleto.Split(' ');
        return partes.Length > 1 ? partes[0] : nomeCompleto;
    }

    private string GetStatusTexto(StatusReserva status)
    {
        return status switch
        {
            StatusReserva.Confirmada => "Confirmada",
            StatusReserva.Pendente => "Pendente",
            StatusReserva.CheckInRealizado => "Check-in",
            StatusReserva.CheckOutRealizado => "Check-out",
            StatusReserva.Cancelada => "Cancelada",
            StatusReserva.NoShow => "No Show",
            _ => ""
        };
    }

    private string GetStatusClass(StatusReserva status)
    {
        return status switch
        {
            StatusReserva.Confirmada => "confirmada",
            StatusReserva.Pendente => "pendente",
            StatusReserva.CheckInRealizado => "checkin",
            StatusReserva.CheckOutRealizado => "checkout",
            StatusReserva.Cancelada => "cancelada",
            _ => ""
        };
    }
}
